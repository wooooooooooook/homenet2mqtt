# μ¤λ‹ν« κ°¤λ¬λ¦¬ κ°€μ΄λ“

μ¤λ‹ν« κ°¤λ¬λ¦¬λ” μ»¤λ®¤λ‹ν‹°μ—μ„ κ³µμ ν• μ„¤μ •μ„ μ›Ή UIμ—μ„ ν™•μΈν•κ³  μ μ©ν•  μ μλ” κΈ°λ¥μ…λ‹λ‹¤. κ° μ¤λ‹ν«μ€ YAML ν•μ‹μΌλ΅ μ κ³µλλ©° μ•„λ ν•­λ©μ„ ν¬ν•¨ν•  μ μμµλ‹λ‹¤.

## κ°¤λ¬λ¦¬ λ°μ΄ν„° μ κ³µ κ²½λ΅

- κ°¤λ¬λ¦¬ λ©λ΅: `/api/gallery/list`
- μ¤λ‹ν« νμΌ: `/api/gallery/file?path=<vendor/file.yaml>`

μ„λΉ„μ¤λ” GitHub μ €μ¥μ†(`https://raw.githubusercontent.com/wooooooooooook/RS485-HomeNet-to-MQTT-bridge/main/gallery/`)μ—μ„ νμΌμ„ κ°€μ Έμ™€ μ„ APIλ΅ ν”„λ΅μ‹ν•©λ‹λ‹¤. μ΄λ¥Ό ν†µν•΄ κ°¤λ¬λ¦¬ μ—…λ°μ΄νΈκ°€ GitHubμ— pushλλ©΄ μλ™μΌλ΅ λ°μλ©λ‹λ‹¤.

## μ¤λ‹ν« κµ¬μ„±

- `entities`: μ—”ν‹°ν‹° μ„¤μ • λ¨μ (`light`, `sensor` λ“± μ—”ν‹°ν‹° νƒ€μ…λ³„ λ°°μ—΄)
- `automation`: μλ™ν™” κ·μΉ™ λ°°μ—΄
- `scripts`: μ¤ν¬λ¦½νΈ μ •μ λ°°μ—΄

`scripts` ν•­λ©μ€ μλ™ν™” μ•΅μ…μ—μ„ μ¬μ‚¬μ©ν•  μ μλ” μ¤ν¬λ¦½νΈ μ •μλ¥Ό λ‹΄μµλ‹λ‹¤. κ°¤λ¬λ¦¬μ—μ„ μ¤λ‹ν«μ„ μ μ©ν•λ©΄ `scripts` ν•­λ©λ„ ν•¨κ» κµ¬μ„± νμΌμ— λ³‘ν•©λ©λ‹λ‹¤.

## ν…ν”λ¦Ώ κΈ°λ° μ¤λ‹ν« μ¤ν‚¤λ§

### λ©ν‘

- **νλΌλ―Έν„° κΈ°λ° ν…ν”λ¦Ώ**: μ‚¬μ©μ μ…λ ¥μ— λ”°λΌ λ™μ μΌλ΅ μ—”ν‹°ν‹° μƒμ„±
- **μ¤‘μ²© λ°λ³µ μ§€μ›**: λ°© κ°μ Γ— μ΅°λ… κ°μμ²λΌ 2λ‹¨κ³„ λ°λ³µ μ²λ¦¬
- **ν•μ„ νΈν™μ„± μ μ§€**: κΈ°μ΅΄ μ •μ  YAML μ¤λ‹ν«μ€ κ·Έλ€λ΅ μ μ©
- **μ•μ „ν• ν‘ν„μ‹ ν‰κ°€**: Common Expression Language (CEL) κΈ°λ°μ μ•μ „ν• μƒλ“λ°•μ¤ μ‹¤ν–‰

### λ©”νƒ€λ°μ΄ν„° (`meta`)

μ¤λ‹ν«μ κΈ°λ³Έ μ •λ³΄λ¥Ό μ •μν•©λ‹λ‹¤.

```yaml
meta:
  name: "My Template"
  author: "User"
  version: "1.0.0"
  min_version: "1.15.0"  # μµμ† μ”κµ¬ μ• λ“μ¨ λ²„μ „
  tags: ["light", "kocom"]
```

`min_version`μ„ λ…μ‹ν•λ©΄ ν•΄λ‹Ή λ²„μ „λ³΄λ‹¤ λ‚®μ€ μ• λ“μ¨μ—μ„λ” μ¤λ‹ν« μ μ©μ΄ μ°¨λ‹¨λκ³  μ—…λ°μ΄νΈ μ•λ‚΄ λ©”μ‹μ§€κ°€ ν‘μ‹λ©λ‹λ‹¤.

### νλΌλ―Έν„° μ •μ (`parameters`)

```yaml
parameters:
  - name: light_count
    type: integer
    default: 4
    min: 1
    max: 8
    label: "μ΅°λ… κ°μ"
    label_en: "Light Count"
    description: "μƒμ„±ν•  μ΅°λ… κ°μλ¥Ό μ…λ ¥ν•μ„Έμ”"
```

μ§€μ› νƒ€μ…:

| νƒ€μ… | μ„¤λ… | μμ‹ |
| --- | --- | --- |
| `integer` | λ‹¨μΌ μ •μ | `4` |
| `string` | λ‹¨μΌ λ¬Έμμ—΄ | `"κ±°μ‹¤"` |
| `integer[]` | μ •μ λ°°μ—΄ | `[4, 3, 2]` |
| `object[]` | κ°μ²΄ λ°°μ—΄ | `[{name: "κ±°μ‹¤", count: 4}]` |

#### νλΌλ―Έν„° κ³ κΈ‰ μ„¤μ •

| μ†μ„± | μ„¤λ… | μμ‹ |
| --- | --- | --- |
| `hidden` | UIμ— ν‘μ‹λμ§€ μ•λ” μ¨κ²¨μ§„ νλΌλ―Έν„°μ…λ‹λ‹¤. | `hidden: true` |
| `computed` | κ³„μ‚°λ νλΌλ―Έν„°μ…λ‹λ‹¤ (λ³΄ν†µ `hidden`κ³Ό ν•¨κ» μ‚¬μ©). | `computed: true` |

> **Tip:** `object[]` νƒ€μ…μ κ²½μ°, λ°°μ—΄ μ•„μ΄ν…μ— μΌλ¶€ μ†μ„±μ΄ λ„λ½λμ–΄ μμΌλ©΄ `schema.properties`μ— μ •μλ `default` κ°’μ΄ μλ™μΌλ΅ λ³‘ν•©λ©λ‹λ‹¤. μλ¥Ό λ“¤μ–΄ Discovery κ²°κ³Όμ— `light_count`κ°€ μ—†λ”λΌλ„ μ¤ν‚¤λ§μ— `default: 2`κ°€ μλ‹¤λ©΄ μλ™μΌλ΅ μ±„μ›μ§‘λ‹λ‹¤.

### μ΅°κ±΄λ¶€ ν¬ν•¨ (`$if`)

νΉμ • μ΅°κ±΄μ— λ”°λΌ μ—”ν‹°ν‹°λ‚ λ…Έλ“λ¥Ό ν¬ν•¨ν•κ±°λ‚ μ μ™Έν•  μ μμµλ‹λ‹¤.

```yaml
entities:
  light:
    - $if: '{{light_count >= 2}}'
      id: 'light_2'
      name: 'Light 2'
```

μ΅°κ±΄μ‹(CEL)μ΄ `true`λ΅ ν‰κ°€λλ©΄ ν•΄λ‹Ή λ…Έλ“κ°€ ν¬ν•¨λκ³ , `false`μ΄λ©΄ κ²°κ³Όμ—μ„ μ™„μ „ν μ κ±°λ©λ‹λ‹¤. `$repeat` λΈ”λ΅ λ‚΄λ¶€λ‚ `nested` κµ¬μ΅°μ—μ„λ„ μ‚¬μ©ν•  μ μμµλ‹λ‹¤.



### λ°λ³µ λΈ”λ΅ (`$repeat`) 

λ‹¨μΌ λ λ²¨ λ°λ³µ:

```yaml
entities:
  light:
    - $repeat:
        count: '{{light_count}}'
        as: i
        start: 1

      id: 'light_{{i}}'
      name: 'Light {{i}}'
      state:
        data: [0xB0, 0x00, '{{i}}']
        mask: [0xF0, 0x00, 0xFF]
      command_on:
        data: [0x31, '{{i}}', 0x01, 0x00, 0x00, 0x00, 0x00]
```

`$repeat` μ†μ„±:

| μ†μ„± | ν•„μ | μ„¤λ… |
| --- | --- | --- |
| `count` | β“ | λ°λ³µ νμ (`μ«μ` λλ” `{{λ³€μ}}`) |
| `as` | β“ | ν„μ¬ μΈλ±μ¤ λ³€μλ… |
| `start` |  | μ‹μ‘ μΈλ±μ¤ (κΈ°λ³Έκ°’: 1) |
| `over` |  | λ°°μ—΄ λ°λ³µ μ‹ λ°°μ—΄ λ³€μλ… (count λ€μ‹  μ‚¬μ©) |
| `index` |  | 0-based μΈλ±μ¤ λ³€μλ… (μ„ νƒ) |

### μ¤‘μ²© λ°λ³µ (`$nested`)

λ°© Γ— μ΅°λ…μ²λΌ 2λ‹¨κ³„ λ°λ³µ:

```yaml
parameters:
  - name: rooms
    type: object[]
    default:
      - name: "κ±°μ‹¤"
        light_count: 4
      - name: "μ•λ°©"
        light_count: 3
    schema:
      name: { type: string, label: "λ°© μ΄λ¦„" }
      light_count: { type: integer, min: 1, max: 8, label: "μ΅°λ… κ°μ" }
entities:
  light:
    - $repeat:
        over: rooms
        as: room
        index: room_idx
      $nested:
        $repeat:
          count: '{{room.light_count}}'
          as: light_num

        id: 'light_{{room_idx + 1}}_{{light_num}}'
        name: '{{room.name}} μ΅°λ… {{light_num}}'
        state:
          data: [0xB0, '{{room_idx + 1}}', '{{light_num}}']
          mask: [0xF0, 0xFF, 0xFF]
        command_on:
          data: [0x31, '{{room_idx + 1}}', '{{light_num}}', 0x01, 0x00, 0x00, 0x00]
```

### ν…ν”λ¦Ώ ν‘ν„μ‹ (Common Expression Language)

ν‘ν„μ‹ λ¬Έλ²•: `{{expression}}`

ν…ν”λ¦Ώ ν‘ν„μ‹μ€ **[Common Expression Language (CEL)](https://github.com/google/cel-spec)**μ„ μ‚¬μ©ν•©λ‹λ‹¤.
- JavaScript λ¬Έλ²•κ³Ό μ μ‚¬ν•μ§€λ§ λ” μ—„κ²©ν•λ©° μ•μ „ν•©λ‹λ‹¤.
- `process`, `window`, `require` λ“± κΈ€λ΅λ² κ°μ²΄μ— μ ‘κ·Όν•  μ μ—†μµλ‹λ‹¤.
- `Math` ν•¨μλ” μ§€μ›λμ§€ μ•μΌλ―€λ΅ κΈ°λ³Έ μ‚¬μΉ™μ—°μ‚°κ³Ό μ κ³µλ ν—¬νΌ ν•¨μλ§ μ‚¬μ©ν•΄μ•Ό ν•©λ‹λ‹¤.

μ§€μ› ν‘ν„μ‹ μμ‹:

| ν‘ν„μ‹ | μ„¤λ… | μμ‹ |
| --- | --- | --- |
| `{{i}}` | λ³€μ μ§μ ‘ μ°Έμ΅° | `1`, `2`, ... |
| `{{i + 1}}` | μ‚°μ  μ—°μ‚° | `2`, `3`, ... |
| `{{i * 2}}` | κ³±μ… | `2`, `4`, ... |
| `{{room.name}}` | κ°μ²΄ μ†μ„± μ ‘κ·Ό | `"κ±°μ‹¤"` |
| `{{hex(i)}}` | ν—¬νΌ ν•¨μ: 16μ§„μ λ³€ν™ | `"0x01"` |
| `{{pad(i, 2)}}` | ν—¬νΌ ν•¨μ: μλ¦Ώμ ν¨λ”© | `"01"` |
| `{{bcd_to_int(i)}}` | BCD β†’ μ •μ λ³€ν™ | `0x12` β†’ `12` |
| `{{int_to_bcd(i)}}` | μ •μ β†’ BCD λ³€ν™ | `12` β†’ `0x12` |
| `{{bitAnd(i, 0x0F)}}` | λΉ„νΈ AND | `0x1F` β†’ `0x0F` |
| `{{bitOr(i, 0x80)}}` | λΉ„νΈ OR | `0x01` β†’ `0x81` |
| `{{bitXor(i, 0xFF)}}` | λΉ„νΈ XOR (λ°μ „) | `0x00` β†’ `0xFF` |
| `{{bitShiftLeft(i, 4)}}` | λΉ„νΈ Left Shift | `0x01` β†’ `0x10` |
| `{{bitShiftRight(i, 4)}}` | λΉ„νΈ Right Shift | `0x10` β†’ `0x01` |

**μ£Όμμ‚¬ν•­:**
- λ³€μλ” `parameters`λ‚ `$repeat`μ—μ„ μ •μλ κ²ƒλ§ μ‚¬μ©ν•  μ μμµλ‹λ‹¤.
- μ •μλμ§€ μ•μ€ λ³€μλ¥Ό μ‚¬μ©ν•λ©΄ μ—λ¬κ°€ λ°μƒν•©λ‹λ‹¤.

## Discovery μ¤ν‚¤λ§

### κ°μ”

Discovery κΈ°λ¥μ€ λΈλ¦Ώμ§€μ—μ„ μμ§‘λ ν¨ν‚·λ”•μ…”λ„λ¦¬λ¥Ό λ¶„μ„ν•μ—¬:
1. **κ°¤λ¬λ¦¬ λ©λ΅**: λ§¤μΉ­λλ” ν¨ν‚·μ΄ μμΌλ©΄ "π” λ°κ²¬λ¨" λ±ƒμ§€ ν‘μ‹
2. **μ¤λ‹ν« λ¨λ‹¬**: λ°κ²¬λ λ””λ°”μ΄μ¤ κ°μλ¥Ό νλΌλ―Έν„° κΈ°λ³Έκ°’μΌλ΅ μλ™ μ…λ ¥

### κΈ°λ³Έ κµ¬μ΅°

```yaml
discovery:
  # ν¨ν‚· λ§¤μΉ­ κ·μΉ™
  match:
    data: [0xB0]              # λ§¤μΉ­ν•  λ°”μ΄νΈ ν¨ν„΄
    mask: [0xF0]              # λΉ„κµ λ§μ¤ν¬ (μ„ νƒ)
    offset: 0                 # μ‹μ‘ μ¤ν”„μ…‹ (κΈ°λ³Έκ°’: 0)

  # λ””λ°”μ΄μ¤ μ‹λ³„ μ°¨μ› μ •μ
  dimensions:
    - parameter: "light_count"
      offset: 2               # data[2]μ—μ„ λ””λ°”μ΄μ¤ ID μ¶”μ¶

  # μ¶”λ΅  μ „λµ
  inference:
    strategy: "count"         # κ³ μ κ°’ κ°μ μ„ΈκΈ°
```

### match (ν¨ν‚· λ§¤μΉ­)

ν¨ν‚·λ”•μ…”λ„λ¦¬μ—μ„ λ¶„μ„ν•  ν¨ν‚·μ„ ν•„ν„°λ§ν•©λ‹λ‹¤.

#### κΈ°λ³Έ λ§¤μΉ­
| μ†μ„± | ν•„μ | μ„¤λ… | μμ‹ |
| --- | --- | --- | --- |
| `data` | β“ | λ§¤μΉ­ν•  λ°”μ΄νΈ ν¨ν„΄ | `[0xB0]`, `[0x0E, 0x00, 0x81]` |
| `mask` |  | λΉ„κµ μ‹ μ μ©ν•  λ§μ¤ν¬ | `[0xF0]` (μƒμ„ 4λΉ„νΈλ§ λΉ„κµ) |
| `offset` |  | ν¨ν‚· λ‚΄ λΉ„κµ μ‹μ‘ μ„μΉ (κΈ°λ³Έ: 0) | `0` |

#### κ³ κΈ‰ λ§¤μΉ­ (Regex, Condition, AnyOf)

λ³µμ΅ν• λ§¤μΉ­μ΄ ν•„μ”ν• κ²½μ° λ‹¤μ μµμ…μ„ μ‚¬μ©ν•  μ μμµλ‹λ‹¤.

**1. Regex λ§¤μΉ­ (`regex`)**
ν¨ν‚·μ Hex λ¬Έμμ—΄ ν‘ν„μ— λ€ν•΄ μ •κ·ν‘ν„μ‹μΌλ΅ λ§¤μΉ­ν•©λ‹λ‹¤.
```yaml
match:
  regex: "B0 41 .. 02"  # 3λ²μ§Έ λ°”μ΄νΈλ” μ™€μΌλ“μΉ΄λ“
```

**2. μ΅°κ±΄λ¶€ λ§¤μΉ­ (`condition`)**
CEL ν‘ν„μ‹μ„ μ‚¬μ©ν•΄ κ°’μ„ λΉ„κµν•©λ‹λ‹¤.
- **Context**: `data` (ν¨ν‚· λ°”μ΄νΈ λ°°μ—΄), `len` (ν¨ν‚· κΈΈμ΄)
```yaml
match:
  condition: "data[2] > 0x10 && data[5] == 0x02"
```

**3. λ‹¤μ¤‘ μ΅°κ±΄ (`any_of`)**
μ—¬λ¬ μ΅°κ±΄ μ¤‘ ν•λ‚λΌλ„ λ§μ΅±ν•λ©΄ λ§¤μΉ­ (OR λ΅μ§).
```yaml
match:
  any_of:
    - data: [0xB0]
    - regex: "A0 .. 01"
```

### dimensions (λ””λ°”μ΄μ¤ μ°¨μ›)

ν•λ‚ μ΄μƒμ νλΌλ―Έν„°λ¥Ό ν¨ν‚· λ°μ΄ν„°μ—μ„ μ¶”μ¶ν•©λ‹λ‹¤.

| μ†μ„± | ν•„μ | μ„¤λ… |
| --- | --- | --- |
| `parameter` | β“ | μ—°κ²°ν•  νλΌλ―Έν„° μ΄λ¦„ |
| `offset` | β“ | κ°’μ„ μ¶”μ¶ν•  λ°”μ΄νΈ μ¤ν”„μ…‹ |
| `mask` |  | μ¶”μ¶ μ‹ μ μ©ν•  λΉ„νΈ λ§μ¤ν¬ |
| `transform` |  | CEL ν‘ν„μ‹μΌλ΅ κ°’ λ³€ν™ (Context: `x`) |

#### μμ‹: CEL Transform μ‚¬μ©
νΉμ • λΉ„νΈλ¥Ό μ¶”μ¶ν•κ±°λ‚ κ°’μ„ λ³€ν™ν•  λ• μ‚¬μ©ν•©λ‹λ‹¤.
```yaml
dimensions:
  - parameter: "room_id"
    offset: 1
    transform: "bitShiftRight(x, 4)" # μƒμ„ 4λΉ„νΈ μ¶”μ¶
```

### inference (μ¶”λ΅  μ „λµ)

| μ „λµ | μ„¤λ… | κ²°κ³Ό μμ‹ |
| --- | --- | --- |
| `max` | μµλ€κ°’ (κΈ°λ³Έκ°’) | `{ light_count: 5 }` |
| `count` | κ³ μ κ°’ κ°μ | `{ light_count: 4 }` |
| `unique_tuples` | λ‹¤μ°¨μ› κ³ μ  μ΅°ν•© | `{ rooms: [{id:1, lights:3}, {id:2, lights:2}] }` |
| `grouped` | κ·Έλ£Ήλ³„ κ°μ | `{ room_lights: {1: 3, 2: 2} }` |

```yaml
inference:
  strategy: "max"  # κΈ°λ³Έκ°’, μƒλµ κ°€λ¥
  # λλ” λ‹¤μ°¨μ›μ©
  strategy: "unique_tuples"
  output: "room_lights"       # object[] νλΌλ―Έν„°λ΅ μ¶λ ¥
```

#### μμ‹: λ‹¤μ°¨μ› μ¶”λ΅  (`unique_tuples`)
λ°© λ²νΈ(`room_idx`)μ™€ μ΅°λ… κ°μ(`count`)λ¥Ό μ΅°ν•©ν•μ—¬ κ°μ²΄ λ°°μ—΄μ„ μƒμ„±ν•λ” μμ‹μ…λ‹λ‹¤.

```yaml
inference:
  strategy: "unique_tuples"
  output: "rooms"  # parametersμ— μλ” 'rooms' (object[]) λ³€μμ— κ²°κ³Ό μ €μ¥
```

μ΄ μ „λµμ€ λ°κ²¬λ κ° νλΌλ―Έν„° μ΅°ν•©μ„ μ μΌν• νν”λ΅ λ§λ“¤μ–΄ λ°°μ—΄λ΅ λ°ν™ν•©λ‹λ‹¤. κ²°κ³Όλ” λ‹¤μκ³Ό κ°™μ€ ν•νƒκ°€ λ©λ‹λ‹¤:
`[{room_idx: 1, count: 2}, {room_idx: 2, count: 1}]`
```
