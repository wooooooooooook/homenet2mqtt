meta:
  name: "Bestin2.0 디밍 조명 및 아웃렛"
  name_en: "Bestin2.0 Dimming Light and Outlet"
  description: >-
    Bestin2.0 디밍 조명 및 아웃렛 설정입니다. 방 개수와 방별 조명/콘센트 개수를 설정할 수 있습니다.
    디밍이 아닌경우 light엔티티에서 디밍관련 옵션들(brightness, color_temp)을 제거하고 사용하세요.
  description_en: >- 
    Bestin2.0 dimming light and outlet configuration. You can configure room count and lights/outlets per room.
    If it's not a dimming light, remove dimming-related options (brightness, color_temp) from the light entity.
  version: "2.1.0"
  author: "wooooooooooook"
  tags: ["light", "outlet", "bestin2.0"]

parameters:
  - name: rooms
    type: object[]
    label: "방별 설정"
    label_en: "Room Settings"
    default:
      - room_id: 1
        light_count: 2
        outlet_count: 2
      - room_id: 2
        light_count: 2
        outlet_count: 2
    schema:
      room_id: { type: integer, min: 1, max: 8, label: "방 번호", label_en: "Room ID" }
      light_count: { type: integer, min: 1, max: 8, label: "조명 개수", label_en: "Light Count" }
      outlet_count: { type: integer, min: 0, max: 4, label: "콘센트 개수", label_en: "Outlet Count" }

discovery:
  match:
    data: [0x30, 0x00, 0x91]
    mask: [0xF0, 0x00, 0xFF]
  dimensions:
    - parameter: "room_id"
      offset: 0
      transform: "bitAnd(x, 0x0F)"
    - parameter: "light_count"
      offset: 10
  inference:
    strategy: "unique_tuples"
    output: "rooms"

entities:
  scripts:
    - id: "update_sequence_number"
      name: "update sequence number"
      actions:
        - action: update_state
          target_id: "sequence_number"
          state:
            state_number: "bitAnd(int(get_from_state('number', -1)) + 1, 0xFF)"

    - id: "make_light_packet"
      name: "Light Packet Make"
      description: >- 
        조명 공통 패킷 생성 
          args: 
            room_number: (1-8)
            position: 조명번호1-based
            ONOFF: 1(on), 2(off) (생략시 1)
            BRIGHTNESS: 0-100 (0xFF: 변경없음, 생략시 0xFF)
            COLOR_TEMP: 0-100 (0xFF: 변경없음, 생략시 0xFF)
      actions:
        - action: send_packet
          data: >- 
            [bitOr(0x30, args.room_number),
            0x0E, 0x21, 
            int(get_from_states('sequence_number', 'number', 0)), 
            0x01, 0x00, 
            int(args.position), int(has(args.ONOFF)?args.ONOFF:1), 
            int(has(args.BRIGHTNESS)?args.BRIGHTNESS:0xFF), 
            int(has(args.COLOR_TEMP)?args.COLOR_TEMP:0xFF), 
            0x00, 0xFF]
          ack: >- 
            [bitOr(0x30, args.room_number), 0x81]
          header: true
          checksum: true
        - action: script
          script: update_sequence_number

    - id: "make_outlet_packet"
      name: "Outlet Packet Make"
      description: >- 
        아웃렛 공통 패킷 생성 
          args: 
            room_number: (1-8)
            position: 콘센트번호1-based
            ONOFF: 1(on), 2(off) 16(대기전력차단on) 17(대기전력차단off)
      actions:
        - action: send_packet
          data: >- 
            [bitOr(0x30, args.room_number), 0x09, 0x22, 
            int(get_from_states('sequence_number', 'number', 0)), 
            0x01, 
            int(args.position), 
            int(args.ONOFF)]
          ack: >- 
            [bitOr(0x30, args.room_number), 0x81]
          header: true
          checksum: true
        - action: script
          script: update_sequence_number

  number:
    - id: sequence_number
      name: "내부관리용시퀀스번호"
      internal: true
      min_value: 0
      max_value: 255
      step: 1
      state: 
        data: [0x00]
        mask: [0x00]
      state_number: 'data[2]==10?data[3]:data[4]'

  light:
    - $repeat:
        over: rooms
        as: room
        index: room_idx
      $nested:
        $repeat:
          count: '{{room.light_count}}'
          as: light_num
          start: 0
        id: 'room{{room.room_id}}_light{{light_num + 1}}'
        name: 'Room{{room.room_id}} Light {{light_num + 1}}'
        state:
          # [3n : room_number, packet_length, 91: 조명응답패킷]
          data: [0x30, 0x00, 0x91]
          mask: [0xF0, 0x00, 0xFF]
          # 헤더의 room_number 매칭
          # data[0] & 0x0F == room.room_id
        state_on: "bitAnd(data[0], 0x0F) == {{room.room_id}} && data[{{18 + light_num * 13}}] == 1"
        state_off: "bitAnd(data[0], 0x0F) == {{room.room_id}} && data[{{18 + light_num * 13}}] == 2"
        state_brightness: "data[{{18 + light_num * 13 + 1}}]"
        state_color_temp: "370 - (data[{{18 + light_num * 13 + 2}}] * (370 - 153) / 100)"
        command_on:
          script: "make_light_packet"
          args:
            room_number: '{{room.room_id}}'
            position: '{{light_num + 1}}'
            ONOFF: 1
        command_off:
          script: "make_light_packet"
          args:
            room_number: '{{room.room_id}}'
            position: '{{light_num + 1}}'
            ONOFF: 2
        command_brightness:
          script: "make_light_packet"
          args:
            room_number: '{{room.room_id}}'
            position: '{{light_num + 1}}'
            BRIGHTNESS: "x"
        command_color_temp:
          script: "make_light_packet"
          args:
            room_number: '{{room.room_id}}'
            position: '{{light_num + 1}}'
            COLOR_TEMP: "int((370 - x) * 100 / (370 - 153)):0"

  switch:
    - $repeat:
        over: rooms
        as: room
        index: room_idx
      $nested:
        $repeat:
          count: '{{room.outlet_count}}'
          as: outlet_num
          start: 0
        id: 'room{{room.room_id}}_outlet{{outlet_num + 1}}'
        name: 'Room{{room.room_id}} Outlet {{outlet_num + 1}}'
        state:
          data: [0x30, 0x00, 0x91]
          mask: [0xF0, 0x00, 0xFF]
        # data[10]: LIGHT_COUNT 
        # offset = 18 + data[10] * 13 + outlet_num * 14
        state_on: "bitAnd(data[0], 0x0F) == {{room.room_id}} && data[{{18}} + data[10]*13 + {{outlet_num * 14}}] == 1"
        state_off: "bitAnd(data[0], 0x0F) == {{room.room_id}} && data[{{18}} + data[10]*13 + {{outlet_num * 14}}] == 2"
        command_on:
          script: "make_outlet_packet"
          args:
            room_number: '{{room.room_id}}'
            position: '{{outlet_num + 1}}'
            ONOFF: 1
        command_off:
          script: "make_outlet_packet"
          args:
            room_number: '{{room.room_id}}'
            position: '{{outlet_num + 1}}'
            ONOFF: 2

    - $repeat:
        over: rooms
        as: room
        index: room_idx
      $nested:
        $repeat:
          count: '{{room.outlet_count}}'
          as: outlet_num
          start: 0
        id: 'room{{room.room_id}}_outlet{{outlet_num + 1}}_standby'
        name: 'Room{{room.room_id}} Outlet {{outlet_num + 1}} Standby'
        state:
          data: [0x30, 0x00, 0x91]
          mask: [0xF0, 0x00, 0xFF]
        # standby offset = outlet_offset + 6
        state_on: "bitAnd(data[0], 0x0F) == {{room.room_id}} && data[{{18}} + data[10]*13 + {{outlet_num * 14}} + 6] == 1"
        state_off: "bitAnd(data[0], 0x0F) == {{room.room_id}} && data[{{18}} + data[10]*13 + {{outlet_num * 14}} + 6] == 2"
        command_on:
          script: "make_outlet_packet"
          args:
            room_number: '{{room.room_id}}'
            position: '{{outlet_num + 1}}'
            ONOFF: 16
        command_off:
          script: "make_outlet_packet"
          args:
            room_number: '{{room.room_id}}'
            position: '{{outlet_num + 1}}'
            ONOFF: 17

  sensor:
    - $repeat:
        over: rooms
        as: room
        index: room_idx
      $nested:
        $repeat:
          count: '{{room.outlet_count}}'
          as: outlet_num
          start: 0
        id: 'room{{room.room_id}}_outlet{{outlet_num + 1}}_power'
        name: 'Room{{room.room_id}} Outlet {{outlet_num + 1}} Power'
        device_class: power
        unit_of_measurement: W
        state:
          data: [0x30, 0x00, 0x91]
          mask: [0xF0, 0x00, 0xFF]
        # power offset = outlet_offset + 9 (2 bytes)
        state_number: "bitAnd(data[0], 0x0F) == {{room.room_id}} ? bitOr(bitShiftLeft(data[{{18}} + data[10]*13 + {{outlet_num * 14}} + 9], 8), data[{{18}} + data[10]*13 + {{outlet_num * 14}} + 10]) / 10.0 : 0"

    - $repeat:
        over: rooms
        as: room
        index: room_idx
      $nested:
        $repeat:
          count: '{{room.outlet_count}}'
          as: outlet_num
          start: 0
        id: 'room{{room.room_id}}_outlet{{outlet_num + 1}}_standby_cutoff_value'
        name: 'Room{{room.room_id}} Outlet {{outlet_num + 1}} Standby Cutoff Value'
        unit_of_measurement: W
        state:
          data: [0x30, 0x00, 0x91]
          mask: [0xF0, 0x00, 0xFF]
        # cutoff offset = outlet_offset + 7 (2 bytes)
        state_number: "bitAnd(data[0], 0x0F) == {{room.room_id}} ? bitOr(bitShiftLeft(data[{{18}} + data[10]*13 + {{outlet_num * 14}} + 7], 8), data[{{18}} + data[10]*13 + {{outlet_num * 14}} + 8]) / 10.0 : 0"
