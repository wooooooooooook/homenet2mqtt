meta:
  name: "Bestin2.0 디밍 조명 및 아웃렛 (방2개 조명2개씩, 아웃렛 2개씩)"
  name_en: "Bestin2.0 Dimming Light and Outlet (2 rooms, 2 lights and 2 outlets each)"
  description: >-
    Bestin2.0 디밍 조명 및 아웃렛 설정입니다. 더 필요한 방, 조명 등은 추가하여 사용하세요.
    디밍이 아닌경우 light엔티티에서 디밍관련 옵션들(brightness, color_temp)을 제거하고 사용하세요.
  description_en: >- 
    Bestin2.0 dimming light and outlet configuration. Add more rooms or lights as needed.
    If it's not a dimming light, remove dimming-related options (brightness, color_temp) from the light entity.
  version: "1.1.0"
  author: "wooooooooooook"
  tags: ["light", "outlet", "bestin2.0"]

entities:
  scripts:
    - id: "update_sequence_number"
      name: "update sequence number"
      actions:
        - action: update_state
          target_id: "sequence_number"
          state:
            state_number: "bitAnd(int(get_from_state('number', -1)) + 1, 0xFF)"

    - id: "make_light_packet"
      name: "Light Packet Make"
      description: >- 
        조명 공통 패킷 생성 
          args: 
            room_number: (1-8)
            position: 조명번호1-based
            ONOFF: 1(on), 2(off) (생략시 1)
            BRIGHTNESS: 0-100 (0xFF: 변경없음, 생략시 0xFF)
            COLOR_TEMP: 0-100 (0xFF: 변경없음, 생략시 0xFF)
      actions:
        - action: send_packet
          data: >- 
            [bitOr(0x30, args.room_number),
            0x0E, 0x21, 
            int(get_from_states('sequence_number', 'number', 0)), 
            0x01, 0x00, 
            int(args.position), int(has(args.ONOFF)?args.ONOFF:1), 
            int(has(args.BRIGHTNESS)?args.BRIGHTNESS:0xFF), 
            int(has(args.COLOR_TEMP)?args.COLOR_TEMP:0xFF), 
            0x00, 0xFF]
          ack: >- 
            [bitOr(0x30, args.room_number), 0x81]
          header: true
          checksum: true
        - action: script
          script: update_sequence_number

    - id: "make_outlet_packet"
      name: "Outlet Packet Make"
      description: >- 
        아웃렛 공통 패킷 생성 
          args: 
            room_number: (1-8)
            position: 콘센트번호1-based
            ONOFF: 1(on), 2(off) 16(대기전력차단on) 17(대기전력차단off)
      actions:
        - action: send_packet
          data: >- 
            [bitOr(0x30, args.room_number), 0x09, 0x22, 
            int(get_from_states('sequence_number', 'number', 0)), 
            0x01, 
            int(args.position), 
            int(args.ONOFF)]
          ack: >- 
            [bitOr(0x30, args.room_number), 0x81]
          header: true
          checksum: true
        - action: script
          script: update_sequence_number

  number:
    - id: sequence_number
      name: "내부관리용시퀀스번호"
      internal: true
      min_value: 0
      max_value: 255
      step: 1
      state: 
        # 언제나 매칭
        data: [0x00]
        mask: [0x00]
      state_number: 'data[2]==10?data[3]:data[4]'

  light:
  # 18번부터 조명 상태 시작. 각 조명당 13바이트  
    - id: 'room1_light1'
      name: 'Room1 Light 1'
      state:
        # [3n : room_number, packet_length, 91: 조명응답패킷]
        data: [0x31, 0x00, 0x91]
        mask: [0xFF, 0x00, 0xFF]
      state_on: "data[18] == 1"
      state_off: "data[18] == 2"
      state_brightness: "data[18+1]"
      state_color_temp: "370 - (data[18+2] * (370 - 153) / 100)"
      command_on:
        script: "make_light_packet"
        args:
          room_number: 1
          position: 1
          ONOFF: 1
      command_off:
        script: "make_light_packet"
        args:
          room_number: 1
          position: 1
          ONOFF: 2 #off가 2
      command_brightness:
        script: "make_light_packet"
        args:
          room_number: 1
          position: 1
          BRIGHTNESS: "x"
      command_color_temp:
        script: "make_light_packet"
        args:
          room_number: 1
          position: 1
          COLOR_TEMP: "int((370 - x) * 100 / (370 - 153)):0"

    - id: 'room1_light2'
      name: 'Room1 Light 2'
      state:
        data: [0x31, 0x00, 0x91]
        mask: [0xFF, 0x00, 0xFF]
      state_on: "data[18+13] == 1"
      state_off: "data[18+13] == 2"
      state_brightness: "data[18+13+1]"
      state_color_temp: "370 - (data[18+13+2] * (370 - 153) / 100)"
      command_on:
        script: "make_light_packet"
        args:
          room_number: 1
          position: 2
          ONOFF: 1
      command_off:
        script: "make_light_packet"
        args:
          room_number: 1
          position: 2
          ONOFF: 2
      command_brightness:
        script: "make_light_packet"
        args:
          room_number: 1
          position: 2
          BRIGHTNESS: "x"
      command_color_temp:
        script: "make_light_packet"
        args:
          room_number: 1
          position: 2
          COLOR_TEMP: "int((370 - x) * 100 / (370 - 153)):0"

    - id: 'room2_light1'
      name: 'Room2 Light 1'
      state:
        # [3n : room_number, packet_length, 91: 조명응답패킷]
        data: [0x32, 0x00, 0x91]
        mask: [0xFF, 0x00, 0xFF]
      state_on: "data[18] == 1"
      state_off: "data[18] == 2"
      state_brightness: "data[18+1]"
      state_color_temp: "370 - (data[18+2] * (370 - 153) / 100)"
      command_on:
        script: "make_light_packet"
        args:
          room_number: 2
          position: 1
          ONOFF: 1
      command_off:
        script: "make_light_packet"
        args:
          room_number: 2
          position: 1
          ONOFF: 2 #off가 2
      command_brightness:
        script: "make_light_packet"
        args:
          room_number: 2
          position: 1
          BRIGHTNESS: "x"
      command_color_temp:
        script: "make_light_packet"
        args:
          room_number: 2
          position: 1
          COLOR_TEMP: "int((370 - x) * 100 / (370 - 153)):0"

    - id: 'room2_light2'
      name: 'Room2 Light 2'
      state:
        data: [0x32, 0x00, 0x91]
        mask: [0xFF, 0x00, 0xFF]
      state_on: "data[18+13] == 1"
      state_off: "data[18+13] == 2"
      state_brightness: "data[18+13+1]"
      state_color_temp: "370 - (data[18+13+2] * (370 - 153) / 100)"
      command_on:
        script: "make_light_packet"
        args:
          room_number: 2
          position: 2
          ONOFF: 1
      command_off:
        script: "make_light_packet"
        args:
          room_number: 2
          position: 2
          ONOFF: 2
      command_brightness:
        script: "make_light_packet"
        args:
          room_number: 2
          position: 2
          BRIGHTNESS: "x"
      command_color_temp:
        script: "make_light_packet"
        args:
          room_number: 2
          position: 2
          COLOR_TEMP: "int((370 - x) * 100 / (370 - 153)):0"
          
  
  switch:
    - id: "room1_outlet1"
      name: "Room1 Outlet 1"
      state:
        data: [0x31, 0x00, 0x91]
        mask: [0xFF, 0x00, 0xFF]
      # 헤더영역 0-17
      # data[10]: LIGHT_COUNT 
      # 각 조명당 13바이트 
      # outlet 데이터는 콘센트당 14바이트
      state_on: 'data[18+data[10]*13] == 1'
      state_off: 'data[18+data[10]*13] == 2'
      command_on:
        script: "make_outlet_packet"
        args:
          room_number: 1
          position: 1
          ONOFF: 1
      command_off:
        script: "make_outlet_packet"
        args:
          room_number: 1
          position: 1
          ONOFF: 2
    - id: "room1_outlet1_standby"
      name: "Room1 Outlet 1 Standby"
      state:
        data: [0x31, 0x00, 0x91]
        mask: [0xFF, 0x00, 0xFF]
      #data[10]: LIGHT_COUNT 각 조명당 13바이트 
      # outlet index 6번이 standby여부
      state_on: 'data[18+data[10]*13+6] == 1'
      state_off: 'data[18+data[10]*13+6] == 2'
      command_on:
        script: "make_outlet_packet"
        args:
          room_number: 1
          position: 1
          ONOFF: 16 #0x10이 standby on
      command_off:
        script: "make_outlet_packet"
        args:
          room_number: 1
          position: 1
          ONOFF: 17 #0x11이 standby off
    - id: "room1_outlet2"
      name: "Room1 Outlet 2"
      state:
        data: [0x31, 0x00, 0x91]
        mask: [0xFF, 0x00, 0xFF]
      state_on: 'data[18+data[10]*13+14] == 1'
      state_off: 'data[18+data[10]*13+14] == 2'
      command_on:
        script: "make_outlet_packet"
        args:
          room_number: 1
          position: 2
          ONOFF: 1
      command_off:
        script: "make_outlet_packet"
        args:
          room_number: 1
          position: 2
          ONOFF: 2
    - id: "room1_outlet2_standby"
      name: "Room1 Outlet 2 Standby"
      state:
        data: [0x31, 0x00, 0x91]
        mask: [0xFF, 0x00, 0xFF]
      state_on: 'data[18+data[10]*13+14+6] == 1'
      state_off: 'data[18+data[10]*13+14+6] == 2'
      command_on:
        script: "make_outlet_packet"
        args:
          room_number: 1
          position: 2
          ONOFF: 16 #0x10이 standby on
      command_off:
        script: "make_outlet_packet"
        args:
          room_number: 1
          position: 2
          ONOFF: 17 #0x11이 standby off
    - id: "room2_outlet1"
      name: "Room2 Outlet 1"
      state:
        data: [0x32, 0x00, 0x91]
        mask: [0xFF, 0x00, 0xFF]
      # 헤더영역 0-17
      # data[10]: LIGHT_COUNT 
      # 각 조명당 13바이트 
      # outlet 데이터는 콘센트당 14바이트
      state_on: 'data[18+data[10]*13] == 1'
      state_off: 'data[18+data[10]*13] == 2'
      command_on:
        script: "make_outlet_packet"
        args:
          room_number: 2
          position: 1
          ONOFF: 1
      command_off:
        script: "make_outlet_packet"
        args:
          room_number: 2
          position: 1
          ONOFF: 2
    - id: "room2_outlet1_standby"
      name: "Room2 Outlet 1 Standby"
      state:
        data: [0x32, 0x00, 0x91]
        mask: [0xFF, 0x00, 0xFF]
      #data[10]: LIGHT_COUNT 각 조명당 13바이트 
      # outlet index 6번이 standby여부
      state_on: 'data[18+data[10]*13+6] == 1'
      state_off: 'data[18+data[10]*13+6] == 2'
      command_on:
        script: "make_outlet_packet"
        args:
          room_number: 2
          position: 1
          ONOFF: 16 #0x10이 standby on
      command_off:
        script: "make_outlet_packet"
        args:
          room_number: 2
          position: 1
          ONOFF: 17 #0x11이 standby off
    - id: "room2_outlet2"
      name: "Room2 Outlet 2"
      state:
        data: [0x32, 0x00, 0x91]
        mask: [0xFF, 0x00, 0xFF]
      state_on: 'data[18+data[10]*13+14] == 1'
      state_off: 'data[18+data[10]*13+14] == 2'
      command_on:
        script: "make_outlet_packet"
        args:
          room_number: 2
          position: 2
          ONOFF: 1
      command_off:
        script: "make_outlet_packet"
        args:
          room_number: 2
          position: 2
          ONOFF: 2
    - id: "room2_outlet2_standby"
      name: "Room2 Outlet 2 Standby"
      state:
        data: [0x32, 0x00, 0x91]
        mask: [0xFF, 0x00, 0xFF]
      state_on: 'data[18+data[10]*13+14+6] == 1'
      state_off: 'data[18+data[10]*13+14+6] == 2'
      command_on:
        script: "make_outlet_packet"
        args:
          room_number: 2
          position: 2
          ONOFF: 16 #0x10이 standby on
      command_off:
        script: "make_outlet_packet"
        args:
          room_number: 2
          position: 2
          ONOFF: 17 #0x11이 standby off
  
  sensor:
    - id: "room1_outlet1_power"
      name: "Room1 Outlet 1 Power"
      device_class: power
      unit_of_measurement: W
      state:
        data: [0x31, 0x00, 0x91]
        mask: [0xFF, 0x00, 0xFF]
      # outlet index 9-10번이 전력사용량 (bigendian /10)
      state_number: "bitOr(bitShiftLeft(data[18+data[10]*13+9], 8), data[18+data[10]*13+10]) / 10"

    - id: "room1_outlet1_standby_cutoff_value"
      name: "Room1 Outlet 1 Standby Cutoff Value"
      unit_of_measurement: W
      state:
        data: [0x31, 0x00, 0x91]
        mask: [0xFF, 0x00, 0xFF]
      # outlet index 7-8번이 전력차단값 (bigendian /10)
      state_number: "bitOr(bitShiftLeft(data[18+data[10]*13+7], 8), data[18+data[10]*13+8]) / 10"

    - id: "room1_outlet2_power"
      name: "Room1 Outlet 2 Power"
      device_class: power
      unit_of_measurement: W
      state:
        data: [0x31, 0x00, 0x91]
        mask: [0xFF, 0x00, 0xFF]
      state_number: "bitOr(bitShiftLeft(data[18+data[10]*13+14+9], 8), data[18+data[10]*13+14+10]) / 10"

    - id: "room1_outlet2_standby_cutoff_value"
      name: "Room1 Outlet 2 Standby Cutoff Value"
      unit_of_measurement: W
      state:
        data: [0x31, 0x00, 0x91]
        mask: [0xFF, 0x00, 0xFF]
      state_number: "bitOr(bitShiftLeft(data[18+data[10]*13+14+7], 8), data[18+data[10]*13+14+8]) / 10"
      
    - id: "room2_outlet1_power"
      name: "Room2 Outlet 1 Power"
      device_class: power
      unit_of_measurement: W
      state:
        data: [0x32, 0x00, 0x91]
        mask: [0xFF, 0x00, 0xFF]
      state_number: "bitOr(bitShiftLeft(data[18+data[10]*13+9], 8), data[18+data[10]*13+10]) / 10"

    - id: "room2_outlet1_standby_cutoff_value"
      name: "Room2 Outlet 1 Standby Cutoff Value"
      unit_of_measurement: W
      state:
        data: [0x32, 0x00, 0x91]
        mask: [0xFF, 0x00, 0xFF]
      state_number: "bitOr(bitShiftLeft(data[18+data[10]*13+7], 8), data[18+data[10]*13+8]) / 10"

    - id: "room2_outlet2_power"
      name: "Room2 Outlet 2 Power"
      device_class: power
      unit_of_measurement: W
      state:
        data: [0x32, 0x00, 0x91]
        mask: [0xFF, 0x00, 0xFF]
      state_number: "bitOr(bitShiftLeft(data[18+data[10]*13+14+9], 8), data[18+data[10]*13+14+10]) / 10"

    - id: "room2_outlet2_standby_cutoff_value"
      name: "Room2 Outlet 2 Standby Cutoff Value"
      unit_of_measurement: W
      state:
        data: [0x32, 0x00, 0x91]
        mask: [0xFF, 0x00, 0xFF]
      state_number: "bitOr(bitShiftLeft(data[18+data[10]*13+14+7], 8), data[18+data[10]*13+14+8]) / 10"
