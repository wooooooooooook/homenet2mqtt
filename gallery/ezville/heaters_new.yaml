meta:
  name: "☑️난방 설정"
  name_en: "☑️Heaters"
  description: "Ezville 난방 온도조절기 설정입니다. 개수를 지정할 수 있습니다. 0.5°C 단위 조절, 외출 모드 지원."
  description_en: "Ezville heating thermostats configuration with count parameter. 0.5°C step and away preset mode."
  version: "2.0.0"
  author: "wooooooooooook"
  tags: ["climate", "heater", "thermostat", "ezville"]

parameters:
  - name: heater_count
    type: integer
    default: 5
    min: 1
    max: 9
    label: "난방 개수"
    label_en: "Number of Heaters"

discovery:
  match:
    data: [0x36, 0x1F, 0x81]
    mask: [0xFF, 0x1F, 0xFF] 
  dimensions:
    - parameter: "heater_count"
      offset: 6
  ui:
    label: "난방"
    label_en: "heaters"
    summary: "난방 {{heater_count}}개 발견됨"
    summary_en: "{{heater_count}} heaters discovered"

entities:
  climate:
    - $repeat:
        count: '{{heater_count}}'
        as: i
        start: 1
      id: 'thermostat_{{i}}'
      name: 'Thermostat {{i}}'
      visual:
        min_temperature: 5 °C
        max_temperature: 40 °C
        temperature_step: 0.5 °C
      state:
        data: [0x36, 0x1F, 0x81]
      
      # Target Temp: index 9, 11, 13...
      # bitAnd(data[9 + (i-1)*2], 0x7F) -> 정수부
      # bitAnd(data[9 + (i-1)*2], 0x80) -> 0.5 유무
      state_temperature_target: >-
        double(bitAnd(data[{{7 + i * 2}}], 0x7F)) + (bitAnd(data[{{7 + i * 2}}], 0x80) != 0 ? 0.5 : 0.0)
      
      # Current Temp: index 10, 12, 14...
      state_temperature_current: >-
        double(bitAnd(data[{{8 + i * 2}}], 0x7F)) + (bitAnd(data[{{8 + i * 2}}], 0x80) != 0 ? 0.5 : 0.0)

      state_off:
        offset: 5
        data: [0x00]
        # Heater 1: mask 0x01, Heater 2: mask 0x02, Heater 3: mask 0x04 ...
        mask: ['{{bitShiftLeft(1, i - 1)}}']
      state_heat:
        offset: 5
        data: ['{{bitShiftLeft(1, i - 1)}}']
        mask: ['{{bitShiftLeft(1, i - 1)}}']
      
      # Preset Away (offset 6)
      state_preset_away:
        offset: 6
        mask: ['{{bitShiftLeft(1, i - 1)}}']
        data: ['{{bitShiftLeft(1, i - 1)}}']
      state_preset_none:
        offset: 6
        mask: ['{{bitShiftLeft(1, i - 1)}}']
        data: [0x00]

      command_off:
        data: [0x36, '{{0x10 + i}}', 0x43, 0x01, 0x00]
        ack: [0x36, '{{0x10 + i}}', 0xc3]
      command_heat:
        data: [0x36, '{{0x10 + i}}', 0x43, 0x01, 0x01]
        ack: [0x36, '{{0x10 + i}}', 0xc3]
      command_temperature: >-
        [[0x36, '{{0x10 + i}}', 0x44, 0x01, x], [0x36, '{{0x10 + i}}', 0xc4]]
      command_preset_away:
        data: [0x36, '{{0x10 + i}}', 0x45, 0x01, 0x01]
        ack: [0x36, '{{0x10 + i}}', 0xc5]
      command_preset_none:
        data: [0x36, '{{0x10 + i}}', 0x45, 0x01, 0x00]
        ack: [0x36, '{{0x10 + i}}', 0xc5]
