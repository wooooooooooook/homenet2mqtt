meta:
  name: "콘센트 대기전력 차단 모드"
  name_en: "Plug Standby Power Cut Mode"
  description: "현대 이마주 스마트 콘센트의 대기전력 차단 모드 스위치입니다. 스마트 콘센트 설정과 함께 사용하세요."
  description_en: "Hyundai Imazu smart plug standby power cut mode switch. Use together with smart plug settings."
  version: "2.0.0"
  author: "wooooooooooook"
  tags: ["switch", "plug", "standby", "power", "hyundai", "imazu"]

parameters:
  - name: rooms
    type: object[]
    label: "방별 설정"
    label_en: "Room Settings"
    default:
      - room_id: 1
        outlet_count: 2
      - room_id: 2
        outlet_count: 2
    schema:
      room_id: { type: integer, min: 1, max: 15, label: "방 번호 (ID)", label_en: "Room ID" }
      outlet_count: { type: integer, min: 1, max: 4, label: "콘센트 개수", label_en: "Outlet Count" }

discovery:
  match:
    data: [0x0B, 0x01, 0x1F, 0x04, 0x57]
    mask: [0x00, 0xff, 0xff, 0xff, 0xff]
  dimensions:
    - parameter: "room_id"
      offset: 6
      transform: "bitShiftRight(x, 4)"
  inference:
    strategy: "unique_tuples"
    output: "rooms"

entities:
  switch:
    - $repeat:
        over: rooms
        as: room
        index: room_idx
      $nested:
        $repeat:
          count: '{{room.outlet_count}}'
          as: outlet_num
          start: 1
        id: 'room_{{room.room_id}}_plug_{{outlet_num}}_mode'
        name: 'Room {{room.room_id}} Plug {{outlet_num}} Standby Mode'
        icon: 'mdi:cog-refresh'
        state:
          # 0x0B 0x01 0x1F 0x04 0x57 [RoomId<<4 | OutletNum]
          data: [0x0B, 0x01, 0x1F, 0x04, 0x57, '{{bitOr(bitShiftLeft(room.room_id, 4), outlet_num)}}']
          mask: [0x00, 0xff, 0xff, 0xff, 0xff, 0xff]
        state_on:
          offset: 8
          data: [0x01]
        state_off:
          offset: 8
          data: [0x02]
        command_on:
          data: [0x0B, 0x01, 0x1F, 0x02, 0x57, '{{bitOr(bitShiftLeft(room.room_id, 4), outlet_num)}}', 0x01, 0x00]
          ack: [0x0B, 0x01, 0x1F, 0x04, 0x57, '{{bitOr(bitShiftLeft(room.room_id, 4), outlet_num)}}', 0x01, 0x01]
        command_off:
          data: [0x0B, 0x01, 0x1F, 0x02, 0x57, '{{bitOr(bitShiftLeft(room.room_id, 4), outlet_num)}}', 0x02, 0x00]
          ack: [0x0B, 0x01, 0x1F, 0x04, 0x57, '{{bitOr(bitShiftLeft(room.room_id, 4), outlet_num)}}', 0x02, 0x02]
