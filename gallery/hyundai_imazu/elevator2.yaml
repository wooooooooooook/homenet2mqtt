meta:
  name: "현대통신 엘리베이터 2대"
  name_en: "Hyundai Telecom Elevator x2"
  description: "현대통신 월패드용 엘리베이터 2대가 있는 경우 호출 및 상태 확인 설정입니다. 참고:https://yogyui.tistory.com/entry/%ED%98%84%EB%8C%80%ED%86%B5%EC%8B%A0-%EC%9B%94%ED%8C%A8%EB%93%9C-RS-485-%ED%86%B5%EC%8B%A0-%ED%94%84%EB%A1%9C%ED%86%A0%EC%BD%9C-%EC%97%98%EB%A6%AC%EB%B2%A0%EC%9D%B4%ED%84%B0-%ED%98%B8%EC%B6%9C"
  description_en: "Elevator call and status configuration for Hyundai Telecom wallpads. Reference: https://yogyui.tistory.com/entry/%ED%98%84%EB%8C%80%ED%86%B5%EC%8B%A0-%EC%9B%94%ED%8C%A8%EB%93%9C-RS-485-%ED%86%B5%EC%8B%A0-%ED%94%84%EB%A1%9C%ED%86%A0%EC%BD%9C-%EC%97%98%EB%A6%AC%EB%B2%A0%EC%9D%B4%ED%84%B0-%ED%98%B8%EC%B6%9C"
  version: "1.0.3"
  author: "wooooooooooook"
  tags: ["elevator", "hyundai", "imazu"]

discovery:
  match:
    data: [0x0D, 0x01, 0x34, 0x01, 0x41]
    mask: [0x00, 0xff, 0xff, 0xff, 0xff]

scripts:
  - id: 'elevator_call_down_script'
    actions:
      - action: send_packet
        data: [0x0B, 0x01, 0x34, 0x04, 0x41, 0x10, 0x00, 0x06]
        # 안되면 아래 패킷으로 시도해보세요.
        # data: [0x0B, 0x01, 0x34, 0x02, 0x41, 0x10, 0x06, 0x00]
        checksum: true
        header: true
        footer: true

  - id: 'elevator_call_up_script'
    actions:
      - action: send_packet
        data: [0x0B, 0x01, 0x34, 0x02, 0x41, 0x10, 0x05, 0x00]
        checksum: true
        header: true
        footer: true

entities:
  text_sensor:
    - id: 'elevator_floor_1'
      name: 'Elevator Floor 1'
      icon: 'mdi:elevator'
      state:
        # Match Query Packet: F7 0D 01 34 01 41 10 00 [State] [Floor] [ID] [CS] EE
        # EV ID가 다른경우 마지막 바이트를 수정해보세요 (3호기)
        data: [0x0D, 0x01, 0x34, 0x01, 0x41, 0x10, 0x00, 0x00, 0x00, 0x03]
        mask: [0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0xFF]
      state_text: >
        data[9] >= 0xB0 ? 'B' + string(data[9] - 0xB0) : string(bcd_to_int(data[9]))

    - id: 'elevator_state_1'
      name: 'Elevator State 1'
      icon: 'mdi:elevator-passenger'
      state:
        data: [0x0D, 0x01, 0x34, 0x01, 0x41, 0x10, 0x00, 0x00, 0x00, 0x03]
        mask: [0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0xFF]
      state_text: >
        bitShiftRight(data[8], 4) == 0xA ? 'Up' : (bitShiftRight(data[8], 4) == 0xB ? 'Down' : 'Idle')

    - id: 'elevator_floor_2'
      name: 'Elevator Floor 2'
      icon: 'mdi:elevator'
      state:
        # Match Query Packet: F7 0D 01 34 01 41 10 00 [State] [Floor] [ID] [CS] EE
        # EV ID가 다른경우 마지막 바이트를 수정해보세요 (4호기)
        data: [0x0D, 0x01, 0x34, 0x01, 0x41, 0x10, 0x00, 0x00, 0x00, 0x04]
        mask: [0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0xFF]
      state_text: >
        data[9] >= 0xB0 ? 'B' + string(data[9] - 0xB0) : string(bcd_to_int(data[9]))

    - id: 'elevator_state_2'
      name: 'Elevator State 2'
      icon: 'mdi:elevator-passenger'
      state:
        data: [0x0D, 0x01, 0x34, 0x01, 0x41, 0x10, 0x00, 0x00, 0x00, 0x04]
        mask: [0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0xFF]
      state_text: >
        bitShiftRight(data[8], 4) == 0xA ? 'Up' : (bitShiftRight(data[8], 4) == 0xB ? 'Down' : 'Idle')

  button:
    - id: 'elevator_call_down'
      name: 'Call Elevator Down'
      icon: 'mdi:elevator-down'
      command_press:
        script: elevator_call_down_script
      discovery_linked_id: 'elevator_floor_1'

    - id: 'elevator_call_up'
      name: 'Call Elevator Up'
      icon: 'mdi:elevator-up'
      command_press:
        script: elevator_call_up_script
      discovery_linked_id: 'elevator_floor_1'
