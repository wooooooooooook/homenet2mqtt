meta:
  name: "☑️환기팬 설정"
  name_en: "☑️Ventilation Fans"
  description: "코맥스 환기팬 설정입니다. 개수를 지정할 수 있습니다. 3단 속도와 Auto/Night 모드를 지원합니다."
  description_en: "Commax ventilation fans with 3-speed control and Auto/Night preset modes. You can specify the count."
  version: "2.0.0"
  author: "wooooooooooook"
  tags: ["fan", "ventilation", "commax"]
parameters:
  - name: fan_count
    type: integer
    default: 1
    min: 1
    max: 9
    label: "환기팬 개수"
    label_en: "Number of Fans"
discovery:
  match:
    data: [0xF6]
    mask: [0xFE]
  dimensions:
    - parameter: "fan_count"
      offset: 2
  inference:
    strategy: max
  ui:
    label: "환기팬"
    label_en: "fans"
    summary: "{fan_count}개 환기팬 발견됨"
    summary_en: "{fan_count} fans discovered"
entities:
  #상태      Head,   ON,   ID,  SPD, 0x00, 0x00, 0x00, add checksum
  #상태 OFF  0xF6, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, add checksum
  #상태 LOW  0xF6, 0x04, 0x01, 0x01, 0x00, 0x00, 0x00, add checksum
  #상태 MID  0xF6, 0x04, 0x01, 0x02, 0x00, 0x00, 0x00, add checksum
  #상태 HIGH 0xF6, 0x04, 0x01, 0x03, 0x00, 0x00, 0x00, add checksum
  #상태 AUTO 0xF6, 0x02, 0x01, 0x01, 0x00, 0x00, 0x00, add checksum
  #상태 NIGH 0xF6, 0x06, 0x01, 0x01, 0x00, 0x00, 0x00, add checksum

  #응답 OFF  0xF8, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, add checksum
  #응답 LOW  0xF8, 0x04, 0x01, 0x01, 0x00, 0x00, 0x00, add checksum
  #응답 MID  0xF8, 0x04, 0x01, 0x02, 0x00, 0x00, 0x00, add checksum
  #응답 HIGH 0xF8, 0x04, 0x01, 0x03, 0x00, 0x00, 0x00, add checksum

  #명령      Head,   ID,  CMD,  SPD, 0x00, 0x00, 0x00, add checksum
  #명령 OFF  0x78, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, add checksum
  #명령 ON   0x78, 0x01, 0x01, 0x04, 0x00, 0x00, 0x00, add checksum
  #명령 LOW  0x78, 0x01, 0x02, 0x01, 0x00, 0x00, 0x00, add checksum
  #명령 MID  0x78, 0x01, 0x02, 0x02, 0x00, 0x00, 0x00, add checksum
  #명령 HIGH 0x78, 0x01, 0x02, 0x03, 0x00, 0x00, 0x00, add checksum
  fan:
    - $repeat:
        count: '{{fan_count}}'
        as: i
        start: 1
      id: 'fan_{{i}}'
      name: 'Fan {{i}}'
      state:
        data: [0xF0, 0x00, '{{i}}']
        mask: [0xF1, 0x00, 0xFF]
      state_on:
        offset: 1
        data: [0x00]
        inverted: True
      state_off:
        offset: 1
        data: [0x00]
      command_on:
        data: [0x78, '{{i}}', 0x01, 0x04, 0x00, 0x00, 0x00]
        ack: [0xF8, 0x04]
      command_off:
        data: [0x78, '{{i}}', 0x01, 0x00, 0x00, 0x00, 0x00]
        ack: [0xF8, 0x00]
      command_speed: >-
        [[0x78, {{i}}, 0x02, x, 0x00, 0x00, 0x00], [0xF8, 0x04]]
      state_speed:
        offset: 3
        signed: False
      preset_modes:
        - 'Auto'
        - 'Night'
      state_preset: >-
        data[1] == 0x02 ? "Auto" : (data[1] == 0x06 ? "Night" : "")
