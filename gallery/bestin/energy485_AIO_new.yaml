meta:
  name: "Bestin aio 조명 및 아웃렛 (energy485)"
  name_en: "Bestin aio Light and Outlet (energy485)"
  description: >-
    Bestin aio gateway용 조명 및 아웃렛 설정입니다. 방별 조명/콘센트 개수를 지정할 수 있습니다.
  description_en: >- 
    Bestin aio gateway light and outlet. You can specify lights/outlets per room.
  version: "2.1.0"
  author: "wooooooooooook"
  tags: ["light", "outlet", "bestin", "aio"]

parameters:
  - name: rooms
    type: object[]
    label: "방별 설정"
    label_en: "Room Settings"
    default:
      - room_id: 1
        light_count: 4
        outlet_count: 2
      - room_id: 2
        light_count: 2
        outlet_count: 2
    schema:
      room_id: { type: integer, min: 1, max: 5, label: "방 번호", label_en: "Room ID" }
      light_count: { type: integer, min: 0, max: 5, label: "조명 개수", label_en: "Light Count" }
      outlet_count: { type: integer, min: 0, max: 2, label: "콘센트 개수", label_en: "Outlet Count" }

discovery:
  match:
    data: [0x02, 0x50, 0x0C, 0x91]
    mask: [0xFF, 0xF0, 0x00, 0xFF]
  dimensions:
    - parameter: "room_id"
      offset: 1
      transform: "bitAnd(x, 0x0F)"
    - parameter: "light_count"
      offset: 6
      detect: "active_bits"
  inference:
    strategy: "unique_tuples"
    output: "rooms"

entities:
  scripts:
    - id: "update_sequence_number"
      name: "update sequence number"
      actions:
        - action: update_state
          target_id: "sequence_number"
          state:
            state_number: "bitAnd(int(get_from_state('number', -1)) + 1, 0xFF)"

    - id: "make_light_packet"
      name: "Light Packet Make"
      description: >- 
        조명 제어 패킷 생성 (AIO, 20바이트)
          args: 
            room_number: (1-5) - 방 ID
            position: 조명번호 0-based (pos_id, 0-4)
            ONOFF: true(on), false(off)
      actions:
        - action: send_packet
          data: >- 
            [0x02, 
            int(0x50 + args.room_number),
            0x0A, 0x12,
            int(get_from_states('sequence_number', 'number', 0)),
            int(args.ONOFF ? 0x01 : 0x00),
            int(args.position == 4 ? 0x10 : bitShiftLeft(0x01, args.position)),
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00]
          ack: >- 
            [0x02, int(0x50 + args.room_number), 0x0A, 0x82]
          header: false
          checksum: true
        - action: script
          script: update_sequence_number

    - id: "make_outlet_packet"
      name: "Outlet Packet Make"
      description: >- 
        콘센트 제어 패킷 생성 (AIO, 20바이트)
          args: 
            room_number: (1-5) - 방 ID
            position: 콘센트번호 0-based (pos_id, 0-1)
            ONOFF: true(on), false(off)
      actions:
        - action: send_packet
          data: >- 
            [0x02, 
            int(0x50 + args.room_number),
            0x0C, 0x12,
            int(get_from_states('sequence_number', 'number', 0)),
            0x00, 0x00, 0x00,
            0x01,
            int(args.position + 1),
            int(args.ONOFF ? 0x01 : 0x02),
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00]
          ack: >- 
            [0x02, int(0x50 + args.room_number), 0x0A, 0x82]
          header: false
          checksum: true
        - action: script
          script: update_sequence_number

  number:
    - id: sequence_number
      name: "내부관리용시퀀스번호"
      internal: true
      min_value: 0
      max_value: 255
      step: 1
      state: 
        data: [0x02, 0x50]
        mask: [0xFF, 0xF0]
      state_number: 'data[4]'

  light:
    - $repeat:
        over: rooms
        as: room
        index: room_idx
      $nested:
        $repeat:
          count: '{{room.light_count}}'
          as: light_num
          start: 0
        id: 'room{{room.room_id}}_light{{light_num + 1}}'
        name: 'Room{{room.room_id}} Light {{light_num + 1}}'
        state:
          data: [0x02, '{{0x50 + room.room_id}}', 0x0C, 0x91]
          mask: [0xFF, 0xFF, 0x00, 0xFF]
        state_on: "bitAnd(data[6], {{bitShiftLeft(0x01, light_num)}}) == {{bitShiftLeft(0x01, light_num)}}"
        state_off: "bitAnd(data[6], {{bitShiftLeft(0x01, light_num)}}) == 0"
        command_on:
          script: "make_light_packet"
          args:
            room_number: '{{room.room_id}}'
            position: '{{light_num}}'
            ONOFF: true
        command_off:
          script: "make_light_packet"
          args:
            room_number: '{{room.room_id}}'
            position: '{{light_num}}'
            ONOFF: false

  switch:
    # Outlets (AIO: 방당 최대 2개)
    - $repeat:
        over: rooms
        as: room
        index: room_idx
      $nested:
        $repeat:
          count: '{{room.outlet_count}}'
          as: outlet_num
          start: 0
        id: 'room{{room.room_id}}_outlet{{outlet_num + 1}}'
        name: 'Room{{room.room_id}} Outlet {{outlet_num + 1}}'
        state:
          data: [0x02, '{{0x50 + room.room_id}}', 0x0C, 0x91]
          mask: [0xFF, 0xFF, 0x00, 0xFF]
        state_on: 'data[{{9 + outlet_num * 5}}] == 0x21 || data[{{9 + outlet_num * 5}}] == 0x11'
        state_off: 'data[{{9 + outlet_num * 5}}] != 0x21 && data[{{9 + outlet_num * 5}}] != 0x11'
        command_on:
          script: "make_outlet_packet"
          args:
            room_number: '{{room.room_id}}'
            position: '{{outlet_num}}'
            ONOFF: true
        command_off:
          script: "make_outlet_packet"
          args:
            room_number: '{{room.room_id}}'
            position: '{{outlet_num}}'
            ONOFF: false

  binary_sensor:
    # Standby Power Cutoff per outlet
    - $repeat:
        over: rooms
        as: room
        index: room_idx
      $nested:
        $repeat:
          count: '{{room.outlet_count}}'
          as: outlet_num
          start: 0
        id: 'room{{room.room_id}}_outlet{{outlet_num + 1}}_standbycut'
        name: 'Room{{room.room_id}} Outlet {{outlet_num + 1}} Standby Cutoff'
        device_class: power
        state:
          data: [0x02, '{{0x50 + room.room_id}}', 0x0C, 0x91]
          mask: [0xFF, 0xFF, 0x00, 0xFF]
        state_on: 'data[{{9 + outlet_num * 5}}] == 0x11 || data[{{9 + outlet_num * 5}}] == 0x13 || data[{{9 + outlet_num * 5}}] == 0x12'
        state_off: 'data[{{9 + outlet_num * 5}}] != 0x11 && data[{{9 + outlet_num * 5}}] != 0x13 && data[{{9 + outlet_num * 5}}] != 0x12'

  sensor:
    # Outlet Power Consumption
    - $repeat:
        over: rooms
        as: room
        index: room_idx
      $nested:
        $repeat:
          count: '{{room.outlet_count}}'
          as: outlet_num
          start: 0
        id: 'room{{room.room_id}}_outlet{{outlet_num + 1}}_power'
        name: 'Room{{room.room_id}} Outlet {{outlet_num + 1}} Power'
        device_class: power
        unit_of_measurement: W
        state:
          data: [0x02, '{{0x50 + room.room_id}}', 0x0C, 0x91]
          mask: [0xFF, 0xFF, 0x00, 0xFF]
        state_number: "bitOr(bitShiftLeft(data[{{10 + outlet_num * 5}}], 8), data[{{11 + outlet_num * 5}}]) / 10.0"
