meta:
  name: "Bestin 환기팬"
  name_en: "Bestin Ventilation Fan"
  description: "Bestin 환기팬 설정입니다. 3단 속도(약/중/강)와 자연환기 모드를 지원합니다. bestin1.0 bestin2.0 공통입니다."
  description_en: "Bestin ventilation fan with 3-speed control and natural ventilation mode. bestin1.0 bestin2.0 common."
  version: "2.1.0"
  author: "wooooooooooook"
  tags: ["fan", "ventilation", "bestin"]

discovery:
  match:
    data: [0x61, 0x00]
    mask: [0xFF, 0x00]

entities:
  scripts:
    - id: "update_sequence_number"
      name: "update sequence number"
      actions:
        - action: update_state
          target_id: "sequence_number"
          state:
            state_number: "bitAnd(int(get_from_state('number', -1)) + 1, 0xFF)"

    - id: "make_fan_packet"
      name: "Fan Packet Make"
      description: >-
        환기팬 공통 패킷 생성
          args:
            command_type: 1(전원), 3(풍속), 7(자연환기)
            value: 전원(0x01:ON, 0x00:OFF), 풍속(1~3단), 자연환기(0x10:ON, 0x00:OFF)
      actions:
        - action: send_packet
          data: >-
            [0x61,
            int(args.command_type),
            int(get_from_states('sequence_number', 'number', 0)),
            0x00,
            args.command_type == 0x03 ? 0x00 : int(args.value),
            args.command_type == 0x03 ? int(args.value) : (args.command_type == 0x01 ? 0x01 : 0x00),
            0x00, 0x00]
          ack: >-
            [0x02, 0x61, 0x81]
          header: true
          checksum: true
        - action: script
          script: update_sequence_number

  number:
    - id: sequence_number
      name: "내부관리용시퀀스번호"
      internal: true
      min_value: 0
      max_value: 255
      step: 1
      state: 
        # 언제나 매칭
        data: [0x00]
        mask: [0x00]
      state_number: 'data[2]==10?data[3]:data[4]'

  fan:
    - id: 'ventilation_fan'
      name: 'Ventilation Fan'
      state:
        # 상태패킷: [0x02, 0x61, packet_length, timestamp, timestamp, 상태비트, 풍속, 0x00, 0x00, checksum]
        data: [0x61, 0x00]
        mask: [0xFF, 0x00]
      # 전원 상태: 바이트5의 비트0 (bitAnd(data[5], 0x01) == 1이면 ON)
      state_on: "bitAnd(data[5], 0x01) == 1"
      state_off: "bitAnd(data[5], 0x01) == 0"
      # 풍속 상태: 바이트6 (0=OFF, 1=약, 2=중, 3=강) -> 0-100% 변환
      # 0->0%, 1->33%, 2->67%, 3->100%
      state_speed: "int(data[6] * 100 / 3)"
      # 자연환기 프리셋: 바이트5의 비트4 (0x10)
      preset_modes:
        - 'Natural'
      state_preset_mode: >-
        bitAnd(data[5], 0x10) == 0x10 ? "Natural" : ""
      command_on:
        script: "make_fan_packet"
        args:
          command_type: 0x01
          value: 0x01
      command_off:
        script: "make_fan_packet"
        args:
          command_type: 0x01
          value: 0x00
      command_speed:
        script: "make_fan_packet"
        args:
          command_type: 0x03
          # 0-100% -> 0-3단계 변환: 0-33->1, 34-66->2, 67-100->3
          value: "x <= 0 ? 0 : (x <= 33 ? 1 : (x <= 66 ? 2 : 3))"
      command_preset_mode:
        script: "make_fan_packet"
        args:
          command_type: 0x07
          value: 'xstr == "Natural" ? 0x10 : 0x00'
