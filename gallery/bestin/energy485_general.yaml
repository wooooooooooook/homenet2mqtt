meta:
  name: "Bestin general 조명 및 아웃렛 (energy485)"
  name_en: "Bestin general Light and Outlet (energy485)"
  description: >-
    Bestin general gateway용 조명 및 아웃렛 설정입니다. 방1은 조명4개+콘센트3개, 방2는 조명2개+콘센트2개입니다.
  description_en: >- 
    Bestin general gateway light and outlet. Room 1 has 4 lights + 3 outlets, Room 2 has 2 lights + 2 outlets.
  version: "2.1.0"
  author: "wooooooooooook"
  tags: ["light", "outlet", "bestin"]

entities:
  scripts:
    - id: "update_sequence_number"
      name: "update sequence number"
      actions:
        - action: update_state
          target_id: "sequence_number"
          state:
            state_number: "bitAnd(int(get_from_state('number', -1)) + 1, 0xFF)"

    - id: "make_light_packet"
      name: "Light Packet Make"
      description: >- 
        조명 제어 패킷 생성 (Gen1/General, 13바이트)
          args: 
            room_number: (1-8)
            position: 조명번호 0-based (pos_id)
            ONOFF: true(on), false(off)
          패킷 구조:
            [5]: room_id & 0x0F
            [6]: (0x01 << pos_id) | position_flag (ON:0x80, OFF:0x00)
            [11]: onoff_value2 (ON:0x04, OFF:0x00)
      actions:
        - action: send_packet
          data: >- 
            [0x31, 0x0D, 0x01, 
            int(get_from_states('sequence_number', 'number', 0)), 
            int(args.room_number),
            int(bitOr(bitShiftLeft(0x01, args.position), args.ONOFF ? 0x80 : 0x00)),
            0x00, 0x00, 0x00, 0x00,
            int(args.ONOFF ? 0x04 : 0x00)]
          ack: >- 
            [0x02, 0x31, 0x81]
          header: true
          checksum: true
        - action: script
          script: update_sequence_number

    - id: "make_outlet_packet"
      name: "Outlet Packet Make"
      description: >- 
        콘센트 제어 패킷 생성 (Gen1/General, 13바이트)
          args: 
            room_number: (1-8)
            position: 콘센트번호 0-based (pos_id)
            ONOFF: true(on), false(off)
          패킷 구조:
            [5]: room_id & 0x0F
            [6]: 0x00 (reserved)
            [7]: (0x01 << pos_id) | position_flag (ON:0x80, OFF:0x00)
            [8]: 0x00 (standbycut 아님)
            [9-10]: 0x00 (reserved)
            [11]: (0x09 << pos_id) 또는 0x00
      actions:
        - action: send_packet
          data: >- 
            [0x31, 0x0D, 0x01, 
            int(get_from_states('sequence_number', 'number', 0)), 
            int(args.room_number),
            0x00,
            int(bitOr(bitShiftLeft(0x01, args.position), args.ONOFF ? 0x80 : 0x00)),
            0x00, 0x00, 0x00,
            int(args.ONOFF ? bitShiftLeft(0x09, args.position) : 0x00)]
          ack: >- 
            [0x02, 0x31, 0x81]
          header: true
          checksum: true
        - action: script
          script: update_sequence_number

    - id: "make_standby_cutoff_packet"
      name: "Standby Cutoff Packet Make"
      description: >- 
        대기전력 차단 제어 패킷 생성 (Gen1/General, 13바이트)
          args: 
            room_number: (1-8)
            ONOFF: true(차단on), false(차단off)
          패킷 구조:
            [5]: room_id & 0x0F
            [6]: 0x00 (reserved)
            [7]: 0x00 (위치 없음)
            [8]: 0x83 (차단 ON), 0x03 (차단 OFF)
            [9-10]: 0x00 (reserved)
            [11]: 0x00 (상태 없음)
      actions:
        - action: send_packet
          data: >- 
            [0x31, 0x0D, 0x01, 
            int(get_from_states('sequence_number', 'number', 0)), 
            int(args.room_number),
            0x00, 0x00,
            int(args.ONOFF ? 0x83 : 0x03),
            0x00, 0x00, 0x00]
          ack: >- 
            [0x02, 0x31, 0x81]
          header: true
          checksum: true
        - action: script
          script: update_sequence_number

  number:
    - id: sequence_number
      name: "내부관리용시퀀스번호"
      internal: true
      min_value: 0
      max_value: 255
      step: 1
      state: 
        # 언제나 매칭
        data: [0x00]
        mask: [0x00]
      state_number: 'data[1]==0x1E ? data[3] : data[4]'

  light:
    # Room 1 Lights (4개)
    - id: 'room1_light1'
      name: 'Room1 Light 1'
      state:
        data: [0x31, 0x1E, 0x91, 0x00, 0x01]
        mask: [0xFF, 0xFF, 0xFF, 0x00, 0x0F]
      state_on: "bitAnd(data[5], 0x01) == 0x01"
      state_off: "bitAnd(data[5], 0x01) == 0"
      command_on:
        script: "make_light_packet"
        args:
          room_number: 1
          position: 0
          ONOFF: true
      command_off:
        script: "make_light_packet"
        args:
          room_number: 1
          position: 0
          ONOFF: false

    - id: 'room1_light2'
      name: 'Room1 Light 2'
      state:
        data: [0x31, 0x1E, 0x91, 0x00, 0x01]
        mask: [0xFF, 0xFF, 0xFF, 0x00, 0x0F]
      state_on: "bitAnd(data[5], 0x02) == 0x02"
      state_off: "bitAnd(data[5], 0x02) == 0"
      command_on:
        script: "make_light_packet"
        args:
          room_number: 1
          position: 1
          ONOFF: true
      command_off:
        script: "make_light_packet"
        args:
          room_number: 1
          position: 1
          ONOFF: false

    - id: 'room1_light3'
      name: 'Room1 Light 3'
      state:
        data: [0x31, 0x1E, 0x91, 0x00, 0x01]
        mask: [0xFF, 0xFF, 0xFF, 0x00, 0x0F]
      state_on: "bitAnd(data[5], 0x04) == 0x04"
      state_off: "bitAnd(data[5], 0x04) == 0"
      command_on:
        script: "make_light_packet"
        args:
          room_number: 1
          position: 2
          ONOFF: true
      command_off:
        script: "make_light_packet"
        args:
          room_number: 1
          position: 2
          ONOFF: false

    - id: 'room1_light4'
      name: 'Room1 Light 4'
      state:
        data: [0x31, 0x1E, 0x91, 0x00, 0x01]
        mask: [0xFF, 0xFF, 0xFF, 0x00, 0x0F]
      state_on: "bitAnd(data[5], 0x08) == 0x08"
      state_off: "bitAnd(data[5], 0x08) == 0"
      command_on:
        script: "make_light_packet"
        args:
          room_number: 1
          position: 3
          ONOFF: true
      command_off:
        script: "make_light_packet"
        args:
          room_number: 1
          position: 3
          ONOFF: false

    # Room 2 Lights (2개)
    - id: 'room2_light1'
      name: 'Room2 Light 1'
      state:
        data: [0x31, 0x1E, 0x91, 0x00, 0x02]
        mask: [0xFF, 0xFF, 0xFF, 0x00, 0x0F]
      state_on: "bitAnd(data[5], 0x01) == 0x01"
      state_off: "bitAnd(data[5], 0x01) == 0"
      command_on:
        script: "make_light_packet"
        args:
          room_number: 2
          position: 0
          ONOFF: true
      command_off:
        script: "make_light_packet"
        args:
          room_number: 2
          position: 0
          ONOFF: false

    - id: 'room2_light2'
      name: 'Room2 Light 2'
      state:
        data: [0x31, 0x1E, 0x91, 0x00, 0x02]
        mask: [0xFF, 0xFF, 0xFF, 0x00, 0x0F]
      state_on: "bitAnd(data[5], 0x02) == 0x02"
      state_off: "bitAnd(data[5], 0x02) == 0"
      command_on:
        script: "make_light_packet"
        args:
          room_number: 2
          position: 1
          ONOFF: true
      command_off:
        script: "make_light_packet"
        args:
          room_number: 2
          position: 1
          ONOFF: false

  switch:
    # Room 1 Outlets (3개)
    - id: "room1_outlet1"
      name: "Room1 Outlet 1"
      state:
        data: [0x31, 0x1E, 0x91, 0x00, 0x01]
        mask: [0xFF, 0xFF, 0xFF, 0x00, 0x0F]
      state_on: 'bitAnd(data[6], 0x01) == 0x01'
      state_off: 'bitAnd(data[6], 0x01) == 0'
      command_on:
        script: "make_outlet_packet"
        args:
          room_number: 1
          position: 0
          ONOFF: true
      command_off:
        script: "make_outlet_packet"
        args:
          room_number: 1
          position: 0
          ONOFF: false

    - id: "room1_outlet2"
      name: "Room1 Outlet 2"
      state:
        data: [0x31, 0x1E, 0x91, 0x00, 0x01]
        mask: [0xFF, 0xFF, 0xFF, 0x00, 0x0F]
      state_on: 'bitAnd(data[6], 0x02) == 0x02'
      state_off: 'bitAnd(data[6], 0x02) == 0'
      command_on:
        script: "make_outlet_packet"
        args:
          room_number: 1
          position: 1
          ONOFF: true
      command_off:
        script: "make_outlet_packet"
        args:
          room_number: 1
          position: 1
          ONOFF: false

    - id: "room1_outlet3"
      name: "Room1 Outlet 3"
      state:
        data: [0x31, 0x1E, 0x91, 0x00, 0x01]
        mask: [0xFF, 0xFF, 0xFF, 0x00, 0x0F]
      state_on: 'bitAnd(data[6], 0x04) == 0x04'
      state_off: 'bitAnd(data[6], 0x04) == 0'
      command_on:
        script: "make_outlet_packet"
        args:
          room_number: 1
          position: 2
          ONOFF: true
      command_off:
        script: "make_outlet_packet"
        args:
          room_number: 1
          position: 2
          ONOFF: false

    # Room 1 Standby Power Cutoff (전역)
    - id: "room1_standby_cutoff"
      name: "Room1 Standby Power Cutoff"
      state:
        data: [0x31, 0x1E, 0x91, 0x00, 0x01]
        mask: [0xFF, 0xFF, 0xFF, 0x00, 0x0F]
      state_on: 'bitAnd(data[6], 0x10) == 0x10'
      state_off: 'bitAnd(data[6], 0x10) == 0'
      command_on:
        script: "make_standby_cutoff_packet"
        args:
          room_number: 1
          ONOFF: true
      command_off:
        script: "make_standby_cutoff_packet"
        args:
          room_number: 1
          ONOFF: false

    # Room 2 Outlets (2개)
    - id: "room2_outlet1"
      name: "Room2 Outlet 1"
      state:
        data: [0x31, 0x1E, 0x91, 0x00, 0x02]
        mask: [0xFF, 0xFF, 0xFF, 0x00, 0x0F]
      state_on: 'bitAnd(data[6], 0x01) == 0x01'
      state_off: 'bitAnd(data[6], 0x01) == 0'
      command_on:
        script: "make_outlet_packet"
        args:
          room_number: 2
          position: 0
          ONOFF: true
      command_off:
        script: "make_outlet_packet"
        args:
          room_number: 2
          position: 0
          ONOFF: false

    - id: "room2_outlet2"
      name: "Room2 Outlet 2"
      state:
        data: [0x31, 0x1E, 0x91, 0x00, 0x02]
        mask: [0xFF, 0xFF, 0xFF, 0x00, 0x0F]
      state_on: 'bitAnd(data[6], 0x02) == 0x02'
      state_off: 'bitAnd(data[6], 0x02) == 0'
      command_on:
        script: "make_outlet_packet"
        args:
          room_number: 2
          position: 1
          ONOFF: true
      command_off:
        script: "make_outlet_packet"
        args:
          room_number: 2
          position: 1
          ONOFF: false

    # Room 2 Standby Power Cutoff (전역)
    - id: "room2_standby_cutoff"
      name: "Room2 Standby Power Cutoff"
      state:
        data: [0x31, 0x1E, 0x91, 0x00, 0x02]
        mask: [0xFF, 0xFF, 0xFF, 0x00, 0x0F]
      state_on: 'bitAnd(data[6], 0x10) == 0x10'
      state_off: 'bitAnd(data[6], 0x10) == 0'
      command_on:
        script: "make_standby_cutoff_packet"
        args:
          room_number: 2
          ONOFF: true
      command_off:
        script: "make_standby_cutoff_packet"
        args:
          room_number: 2
          ONOFF: false

  sensor:
    # Room 1 Outlet Cutoff Values
    - id: "room1_outlet1_cutoff"
      name: "Room1 Outlet 1 Standby Cutoff Value"
      unit_of_measurement: W
      state:
        data: [0x31, 0x1E, 0x91, 0x00, 0x01]
        mask: [0xFF, 0xFF, 0xFF, 0x00, 0x0F]
      state_number: "bitOr(bitShiftLeft(data[7], 8), data[8]) / 10.0"

    - id: "room1_outlet2_cutoff"
      name: "Room1 Outlet 2 Standby Cutoff Value"
      unit_of_measurement: W
      state:
        data: [0x31, 0x1E, 0x91, 0x00, 0x01]
        mask: [0xFF, 0xFF, 0xFF, 0x00, 0x0F]
      state_number: "bitOr(bitShiftLeft(data[9], 8), data[10]) / 10.0"

    # Room 1 DC Voltage
    - id: "room1_dc_voltage"
      name: "Room1 DC Voltage"
      device_class: voltage
      unit_of_measurement: V
      state:
        data: [0x31, 0x1E, 0x91, 0x00, 0x01]
        mask: [0xFF, 0xFF, 0xFF, 0x00, 0x0F]
      state_number: "bitOr(bitShiftLeft(data[11], 8), data[12]) / 10.0"

    # Room 1 Outlet Power Consumption
    - id: "room1_outlet1_power"
      name: "Room1 Outlet 1 Power"
      device_class: power
      unit_of_measurement: W
      state:
        data: [0x31, 0x1E, 0x91, 0x00, 0x01]
        mask: [0xFF, 0xFF, 0xFF, 0x00, 0x0F]
      state_number: "bitOr(bitShiftLeft(data[13], 8), data[14]) / 10.0"

    - id: "room1_outlet2_power"
      name: "Room1 Outlet 2 Power"
      device_class: power
      unit_of_measurement: W
      state:
        data: [0x31, 0x1E, 0x91, 0x00, 0x01]
        mask: [0xFF, 0xFF, 0xFF, 0x00, 0x0F]
      state_number: "bitOr(bitShiftLeft(data[15], 8), data[16]) / 10.0"

    - id: "room1_outlet3_power"
      name: "Room1 Outlet 3 Power"
      device_class: power
      unit_of_measurement: W
      state:
        data: [0x31, 0x1E, 0x91, 0x00, 0x01]
        mask: [0xFF, 0xFF, 0xFF, 0x00, 0x0F]
      state_number: "bitOr(bitShiftLeft(data[17], 8), data[18]) / 10.0"

    - id: "room1_outlet4_power"
      name: "Room1 Outlet 4 Power"
      device_class: power
      unit_of_measurement: W
      state:
        data: [0x31, 0x1E, 0x91, 0x00, 0x01]
        mask: [0xFF, 0xFF, 0xFF, 0x00, 0x0F]
      state_number: "bitOr(bitShiftLeft(data[19], 8), data[20]) / 10.0"

    # Room 2 Outlet Cutoff Values
    - id: "room2_outlet1_cutoff"
      name: "Room2 Outlet 1 Standby Cutoff Value"
      unit_of_measurement: W
      state:
        data: [0x31, 0x1E, 0x91, 0x00, 0x02]
        mask: [0xFF, 0xFF, 0xFF, 0x00, 0x0F]
      state_number: "bitOr(bitShiftLeft(data[7], 8), data[8]) / 10.0"

    - id: "room2_outlet2_cutoff"
      name: "Room2 Outlet 2 Standby Cutoff Value"
      unit_of_measurement: W
      state:
        data: [0x31, 0x1E, 0x91, 0x00, 0x02]
        mask: [0xFF, 0xFF, 0xFF, 0x00, 0x0F]
      state_number: "bitOr(bitShiftLeft(data[9], 8), data[10]) / 10.0"

    # Room 2 DC Voltage
    - id: "room2_dc_voltage"
      name: "Room2 DC Voltage"
      device_class: voltage
      unit_of_measurement: V
      state:
        data: [0x31, 0x1E, 0x91, 0x00, 0x02]
        mask: [0xFF, 0xFF, 0xFF, 0x00, 0x0F]
      state_number: "bitOr(bitShiftLeft(data[11], 8), data[12]) / 10.0"

    # Room 2 Outlet Power Consumption
    - id: "room2_outlet1_power"
      name: "Room2 Outlet 1 Power"
      device_class: power
      unit_of_measurement: W
      state:
        data: [0x31, 0x1E, 0x91, 0x00, 0x02]
        mask: [0xFF, 0xFF, 0xFF, 0x00, 0x0F]
      state_number: "bitOr(bitShiftLeft(data[13], 8), data[14]) / 10.0"

    - id: "room2_outlet2_power"
      name: "Room2 Outlet 2 Power"
      device_class: power
      unit_of_measurement: W
      state:
        data: [0x31, 0x1E, 0x91, 0x00, 0x02]
        mask: [0xFF, 0xFF, 0xFF, 0x00, 0x0F]
      state_number: "bitOr(bitShiftLeft(data[15], 8), data[16]) / 10.0"
