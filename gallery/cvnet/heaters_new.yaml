meta:
  name: "난방 설정"
  name_en: "Heaters"
  description: "CVNet 난방 온도조절기 설정입니다. 개수를 지정할 수 있습니다."
  description_en: "CVNet heating thermostats. You can specify the number of thermostats."
  version: "2.1.2"
  min_version: "1.16.0"
  author: "wooooooooooook"
  tags: ["climate", "heater", "thermostat", "cvnet"]

parameters:
  - name: heater_count
    type: integer
    default: 4
    min: 1
    max: 8
    label: "난방 개수"
    label_en: "Number of Heaters"

discovery:
  match:
    data: [0x20, 0x01, 0x4A]
    mask: [0xFF, 0xFF, 0xFE]
  dimensions:
    - parameter: "heater_count"
      offset: 0
      # CVNet 난방 패킷은 [0xF7, 0x20, 0x01, 0x4A/0x4B, 0x81 ...] 형태이며 heater당 2바이트 데이터
      # Header(5)+Footer(1)+CS(1)? Overhead 7 bytes assumed per user request.
      # 공식: (전체길이 - 7) / 2
      transform: "int((len(data) - 7) / 2)"

entities:
  climate:
    - $repeat:
        count: '{{heater_count}}'
        as: i
        start: 1
      id: 'heater_{{i}}'
      name: 'Heater {{i}}'
      visual:
        min_temperature: 6 °C
        max_temperature: 30 °C
        temperature_step: 1 °C
      state:
        data: [0x20, 0x01, '{{i <= 4 ? 0x4A : 0x4B}}']
      state_temperature_current:
        offset: '{{4 + (i <= 4 ? i : i - 4) * 2}}'
      state_temperature_target: >-
        bitAnd(data[{{3 + (i <= 4 ? i : i - 4) * 2}}], 0x7F)
      state_off:
        offset: '{{3 + (i <= 4 ? i : i - 4) * 2}}'
        data: [0x00]
        mask: [0x80]
      state_heat:
        offset: '{{3 + (i <= 4 ? i : i - 4) * 2}}'
        data: [0x80]
        mask: [0x80]
      command_off: >-
        [[0x20, {{0x40 + i}}, 0x01, 0x11, int(get_from_state('target_temperature', 0)), 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00], [0x20, 0x01, {{0x40 + i}}, 0x91]]
      command_heat: >-
        [[0x20, {{0x40 + i}}, 0x01, 0x11, int(get_from_state('target_temperature', 0)) + 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00], [0x20, 0x01, {{0x40 + i}}, 0x91]]
      command_temperature: >-
        [[0x20, {{0x40 + i}}, 0x01, 0x11, int(x) + 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00], [0x20, 0x01, {{0x40 + i}}, 0x91]]
