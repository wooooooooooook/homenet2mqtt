name: Deploy Addon

on:
  workflow_dispatch:
    inputs:
      increment:
        description: 'Version increment type (patch/minor/major/none)'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major
          - none

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Prepare version
        id: get_version
        run: |
          # Read current version from config.yaml
          CURRENT_VERSION=$(grep '^version:' hassio-addon/config.yaml | awk '{print $2}' | tr -d '"' | tr -d '\r' | xargs)
          IFS='.' read -r major minor patch <<< "$CURRENT_VERSION"

          INCREMENT="${{ github.event.inputs.increment }}"
          NEW_VERSION="$CURRENT_VERSION"

          if [ "$INCREMENT" == "major" ]; then
            major=$((major + 1))
            minor=0
            patch=0
            NEW_VERSION="$major.$minor.$patch"
          elif [ "$INCREMENT" == "minor" ]; then
            minor=$((minor + 1))
            patch=0
            NEW_VERSION="$major.$minor.$patch"
          elif [ "$INCREMENT" == "patch" ]; then
            patch=$((patch + 1))
            NEW_VERSION="$major.$minor.$patch"
          fi

          echo "Current version: $CURRENT_VERSION"
          echo "Target version: $NEW_VERSION"

          if [ "$INCREMENT" != "none" ]; then
             echo "Updating config.yaml to $NEW_VERSION"
             sed -i "s/^version: .*/version: $NEW_VERSION/" hassio-addon/config.yaml
             echo "Updating package.json to $NEW_VERSION"
             npm version $NEW_VERSION --no-git-tag-version --allow-same-version
          fi

          echo "VERSION=$NEW_VERSION" >> $GITHUB_OUTPUT

          if [ "$INCREMENT" != "none" ]; then
             echo "Syncing versions across all packages"
             node scripts/sync-versions.mjs
          fi

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Check if image exists
        id: check_image
        env:
          DOCKER_CLI_EXPERIMENTAL: enabled
        run: |
          if docker manifest inspect nubiz/homenet2mqtt:${{ steps.get_version.outputs.VERSION }} > /dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "Image nubiz/homenet2mqtt:${{ steps.get_version.outputs.VERSION }} already exists."
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "Image not found. Will build."
          fi

      - name: Determine Architectures
        if: steps.check_image.outputs.exists != 'true'
        id: determine_arch
        run: |
          echo "Determining architectures from hassio-addon/build.yaml..."
          ARCHS=$(yq -r '.build_from | keys | .[]' hassio-addon/build.yaml)
          PLATFORMS=""
          for arch in $ARCHS; do
            case $arch in
              aarch64) PLAT="linux/arm64" ;;
              amd64)   PLAT="linux/amd64" ;;
              *)       echo "Warning: Unknown architecture $arch"; continue ;;
            esac
            if [ -z "$PLATFORMS" ]; then
              PLATFORMS="$PLAT"
            else
              PLATFORMS="$PLATFORMS,$PLAT"
            fi
          done
          echo "Platforms: $PLATFORMS"
          echo "platforms=$PLATFORMS" >> $GITHUB_OUTPUT

      - name: Set up QEMU
        if: steps.check_image.outputs.exists != 'true'
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        if: steps.check_image.outputs.exists != 'true'
        uses: docker/setup-buildx-action@v3

      - name: Build and push
        if: steps.check_image.outputs.exists != 'true'
        uses: docker/build-push-action@v5
        with:
          context: .
          file: hassio-addon/Dockerfile
          platforms: ${{ steps.determine_arch.outputs.platforms }}
          push: true
          tags: |
            nubiz/homenet2mqtt:latest
            nubiz/homenet2mqtt:${{ steps.get_version.outputs.VERSION }}
          build-args: |
            LOG_COLLECTOR_API_KEY=${{ secrets.LOG_COLLECTOR_API_KEY }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Multi-arch smoke test
        if: steps.check_image.outputs.exists != 'true'
        run: |
          for PLATFORM in linux/amd64 linux/arm64; do
            echo "Testing $PLATFORM"
            docker run --rm --entrypoint node --platform $PLATFORM nubiz/homenet2mqtt:${{ steps.get_version.outputs.VERSION }} \
              -v || exit 1
          done

      - name: Commit and Push Version
        if: ${{ github.event.inputs.increment != 'none' && steps.check_image.outputs.exists != 'true' }}
        run: |
          NEW_VERSION="${{ steps.get_version.outputs.VERSION }}"
          echo "Committing version bump to $NEW_VERSION"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add hassio-addon/config.yaml package.json packages/*/package.json
          git commit -m "chore: bump addon version to $NEW_VERSION"
          git pull --rebase origin ${{ github.ref_name }}
          git push origin HEAD:${{ github.ref }}

  sync-addon-repo:
    needs: build
    runs-on: ubuntu-latest
    if: success()
    steps:
      - name: Checkout Source
        uses: actions/checkout@v4
        with:
          path: source
          ref: ${{ github.ref }} # Checkout the latest commit (including version bump if applicable)

      - name: Checkout Target Repo
        uses: actions/checkout@v4
        with:
          repository: wooooooooooook/HAaddons
          token: ${{ secrets.ADDONS_REPO_TOKEN }}
          path: target

      - name: Sync Files
        run: |
          mkdir -p target/Homenet2MQTT
          cp -r source/hassio-addon/* target/Homenet2MQTT/
          
          # Check for changes
          cd target
          if [[ -n $(git status -s) ]]; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add .
            git commit -m "Update Homenet2MQTT addon from source"
            git push
          else
            echo "No changes to sync."
          fi
