x-dev-base: &dev-base
  image: rs485-dev-base:latest
  build:
    context: .
    dockerfile: Dockerfile.dev
  working_dir: /workspace
  environment:
    PNPM_HOME: /root/.local/share/pnpm
    PATH: /root/.local/share/pnpm:$PATH
  volumes:
    - ../../:/workspace
    - pnpm-store:/root/.local/share/pnpm

services:
  mq:
    image: eclipse-mosquitto:2
    container_name: rs485-mqtt-dev
    ports:
      - '1883:1883'
      - '9001:9001'
    volumes:
      - mosquitto_data:/mosquitto/data
      - mosquitto_log:/mosquitto/log
      - ./mosquitto/mosquitto.conf:/mosquitto/config/mosquitto.conf:ro
    restart: unless-stopped

  mqtt-explorer:
    image: smeagolworms4/mqtt-explorer
    container_name: rs485-mqtt-explorer-dev
    ports:
      - '9000:4000'
    depends_on:
      mq:
        condition: service_started
    restart: unless-stopped

  homeassistant:
    image: ghcr.io/home-assistant/home-assistant:stable
    container_name: home-assistant-dev
    ports:
      - '8123:8123'
    volumes:
      - homeassistant_config:/config
    environment:
      - TZ=UTC
    depends_on:
      mq:
        condition: service_started
    restart: unless-stopped

  simulator:
    <<: *dev-base
    container_name: rs485-simulator-dev
    environment:
      SIMULATOR_INTERVAL_MS: '100'
      SIMULATOR_PROTOCOL: 'tcp'
      SIMULATOR_PORT_PATH: '/tmp/ttyRS485'
      SIMULATOR_DEVICE: 'userdata'
      SIMULATOR_SLOW: '20'
    volumes:
      - ../../:/workspace
      - pnpm-store:/root/.local/share/pnpm
      - simulator_node_modules:/workspace/node_modules
    command: >
      bash -lc "
        set -euo pipefail
        # Start socat if NOT in tcp mode (in tcp mode, the simulator itself binds the port)
        if [ "$$SIMULATOR_PROTOCOL" != "tcp" ]; then
          nohup socat TCP-LISTEN:8888,fork PTY,link=/tmp/ttyRS485,raw,echo=0,mode=666,b9600,inpck=0 > /tmp/socat.log 2>&1 &
        fi
        
        corepack enable
        pnpm install --filter @rs485-homenet/simulator... --no-frozen-lockfile
        pnpm --filter @rs485-homenet/simulator build
        node scripts/run-simulator.mjs
      "
    depends_on:
      mq:
        condition: service_started
    restart: unless-stopped

  app:
    <<: *dev-base
    container_name: rs485-app-dev
    environment:
      MQTT_URL: mqtt://mq:1883
      SERIAL_PATH_WAIT_TIMEOUT_MS: '10000'
      PORT: '3000'
      CONFIG_ROOT: /workspace/deploy/.configs
      CONFIG_FILES:
      LOG_LEVEL: info
      MQTT_TOPIC_PREFIX: homenet
    volumes:
      - ../../:/workspace
      - pnpm-store:/root/.local/share/pnpm
      - app_node_modules:/workspace/node_modules
      - /dev/pts:/dev/pts
    ports:
      - '3000:3000'
    command: >
      bash -lc "
        set -euo pipefail
        # Connect to simulator via TCP and expose as PTY
        nohup socat PTY,link=/dev/ttyRS485,raw,echo=0,mode=666,b9600,inpck=0 TCP:simulator:8888,retry=10,interval=1 > /tmp/socat.log 2>&1 &
        
        corepack enable
        # Use frozen lockfile for faster install
        pnpm install --filter @rs485-homenet/service... --filter @rs485-homenet/core... --filter @rs485-homenet/ui... --frozen-lockfile

        # Pre-build packages to avoid race conditions and speed up startup
        echo '[app] Building core...'
        pnpm --filter @rs485-homenet/core build
        echo '[app] Building service...'
        pnpm --filter @rs485-homenet/service build
        
        # Start dev servers
        echo '[app] Starting dev servers...'
        pnpm --filter @rs485-homenet/core dev | pnpm pino-pretty &
        pnpm --filter @rs485-homenet/service dev | pnpm pino-pretty
      "
    depends_on:
      simulator:
        condition: service_started
      mq:
        condition: service_started
    restart: unless-stopped

  ui:
    <<: *dev-base
    container_name: rs485-ui-dev
    volumes:
      - ../../:/workspace
      - pnpm-store:/root/.local/share/pnpm
      - ui_node_modules:/workspace/node_modules
    ports:
      - '5173:5173'
    command: >
      bash -lc "
        set -euo pipefail
        corepack enable
        pnpm install --filter @rs485-homenet/ui... --no-frozen-lockfile
        pnpm --filter @rs485-homenet/ui dev --host 0.0.0.0
      "
    depends_on:
      app:
        condition: service_started
    restart: unless-stopped

volumes:
  mosquitto_data:
  mosquitto_log:
  homeassistant_config:
  pnpm-store:
  simulator_node_modules:
  app_node_modules:
  ui_node_modules:
