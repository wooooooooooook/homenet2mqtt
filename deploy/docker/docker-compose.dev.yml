x-dev-base: &dev-base
  image: rs485-dev-base:latest
  build:
    context: ../../
    dockerfile: deploy/docker/Dockerfile.dev
  working_dir: /workspace
  environment:
    PNPM_HOME: /root/.local/share/pnpm
    PATH: /root/.local/share/pnpm:$PATH
  volumes:
    - pnpm-store:/root/.local/share/pnpm
    - turbo-cache:/workspace/.turbo

services:
  mq:
    image: eclipse-mosquitto:2
    container_name: rs485-mqtt-dev
    ports:
      - '1883:1883'
      - '9001:9001'
    volumes:
      - mosquitto_data:/mosquitto/data
      - mosquitto_log:/mosquitto/log
      - ./mosquitto/mosquitto.conf:/mosquitto/config/mosquitto.conf:ro
    restart: unless-stopped

  mqtt-explorer:
    image: smeagolworms4/mqtt-explorer
    container_name: rs485-mqtt-explorer-dev
    ports:
      - '9000:4000'
    depends_on:
      mq:
        condition: service_started
    restart: unless-stopped

  homeassistant:
    image: ghcr.io/home-assistant/home-assistant:stable
    container_name: home-assistant-dev
    ports:
      - '8123:8123'
    volumes:
      - homeassistant_config:/config
    environment:
      - TZ=UTC
    restart: unless-stopped

  simulator:
    <<: *dev-base
    container_name: rs485-simulator-dev
    environment:
      CI: 'true'
      SIMULATOR_INTERVAL_MS: '100'
      SIMULATOR_PROTOCOL: 'serial'
      SIMULATOR_PORT_PATH: '/tmp/ttyRS485'
      SIMULATOR_DEVICE: 'userdata'
      SIMULATOR_SLOW: '5'
    volumes:
      # No workspace mount -> Uses built-in code from image
      - pnpm-store:/root/.local/share/pnpm
      - simulator_node_modules:/workspace/node_modules
    command: >
      bash -lc "
        set -euo pipefail
        # Start socat if NOT in tcp mode (in tcp mode, the simulator itself binds the port)
        if [ "$$SIMULATOR_PROTOCOL" != "tcp" ]; then
          nohup socat PTY,link=/tmp/ttyRS485,raw,echo=0,mode=666 PTY,link=/tmp/ttyRS485_bridge,raw,echo=0,mode=666 > /tmp/socat_pty.log 2>&1 &
          for i in $$(seq 1 50); do [ -e /tmp/ttyRS485_bridge ] && break; sleep 0.1; done
          nohup socat TCP-LISTEN:8888,fork,reuseaddr OPEN:/tmp/ttyRS485_bridge,raw,nonblock > /tmp/socat_tcp.log 2>&1 &
          for i in $$(seq 1 50); do [ -e /tmp/ttyRS485 ] && break; sleep 0.1; done
        fi
        
        corepack enable
        pnpm install --filter @rs485-homenet/simulator... --frozen-lockfile
        pnpm --filter @rs485-homenet/simulator build
        node scripts/run-simulator.mjs
      "
    restart: unless-stopped

  app:
    build:
      context: ../../
      dockerfile: deploy/docker/app.Dockerfile
    image: nubiz/homenet2mqtt:dev
    container_name: rs485-app-dev
    environment:
      CI: 'true'
      MQTT_URL: mqtt://mq:1883
      SERIAL_PATH_WAIT_TIMEOUT_MS: '10000'
      PORT: '3000'
      CONFIG_ROOT: /config
      CONFIG_FILES:
      LOG_LEVEL: info
      MQTT_TOPIC_PREFIX: homenet
    volumes:
      - config_data:/config
      - /dev/pts:/dev/pts
      - ../../gallery:/gallery
    ports:
      - '3000:3000'
    privileged: true
    entrypoint: [ "/sbin/tini", "--" ]
    command: >
      bash -c "
        # Connect to simulator via TCP and expose as PTY
        socat PTY,link=/dev/ttyRS485,raw,echo=0,mode=666,b9600,inpck=0 TCP:simulator:8888,retry=30,interval=2 &
        sleep 1
        exec /run.sh
      "
    restart: unless-stopped

  ui:
    <<: *dev-base
    container_name: rs485-ui-dev
    environment:
      CI: 'true'
    volumes:
      - ../../:/workspace
      - pnpm-store:/root/.local/share/pnpm
      - ui_node_modules:/workspace/node_modules
    ports:
      - '5173:5173'
    command: >
      bash -lc "
        set -euo pipefail
        corepack enable
        pnpm install --filter @rs485-homenet/ui... --frozen-lockfile
        pnpm --filter @rs485-homenet/ui dev --host 0.0.0.0
      "
    depends_on:
      app:
        condition: service_started
    restart: unless-stopped

volumes:
  mosquitto_data:
  mosquitto_log:
  homeassistant_config:
  pnpm-store:
  simulator_node_modules:
  app_node_modules:
  ui_node_modules:
  turbo-cache:
  config_data:
