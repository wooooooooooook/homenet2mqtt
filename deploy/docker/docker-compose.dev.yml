version: '3.9'

x-dev-base: &dev-base
  image: node:20-slim
  working_dir: /workspace
  environment:
    PNPM_HOME: /root/.local/share/pnpm
    PATH: /root/.local/share/pnpm:$PATH
  volumes:
    - ../../:/workspace
    - pnpm-store:/root/.local/share/pnpm

services:
  mq:
    image: eclipse-mosquitto:2
    container_name: rs485-mqtt-dev
    ports:
      - '1883:1883'
    volumes:
      - mosquitto_data:/mosquitto/data
      - mosquitto_log:/mosquitto/log
      - ./mosquitto/mosquitto.conf:/mosquitto/config/mosquitto.conf:ro
    restart: unless-stopped

  homeassistant:
    image: ghcr.io/home-assistant/home-assistant:stable
    container_name: home-assistant-dev
    ports:
      - '8123:8123'
    volumes:
      - homeassistant_config:/config
    environment:
      - TZ=UTC
    depends_on:
      mq:
        condition: service_started
    restart: unless-stopped

  simulator:
    <<: *dev-base
    container_name: rs485-simulator-dev
    environment:
      SIMULATOR_LINK_PATH: /simshare/rs485-sim-tty
      SIMULATOR_INTERVAL_MS: '1000'
    volumes:
      - ../../:/workspace
      - pnpm-store:/root/.local/share/pnpm
      - simulator_node_modules:/workspace/node_modules
      - simshare:/simshare
    command: >
      bash -lc "
        set -euo pipefail
        corepack enable
        pnpm install --filter @rs485-homenet/simulator... --no-frozen-lockfile
        pnpm --filter @rs485-homenet/simulator build
        node scripts/run-simulator.mjs
      "
    depends_on:
      mq:
        condition: service_started
    restart: unless-stopped

  core:
    <<: *dev-base
    container_name: rs485-core-dev
    environment:
      SERIAL_PORT: /simshare/rs485-sim-tty
      BAUD_RATE: '9600'
      MQTT_URL: mqtt://mq:1883
    volumes:
      - ../../:/workspace
      - pnpm-store:/root/.local/share/pnpm
      - core_node_modules:/workspace/node_modules
      - simshare:/simshare
    command: >
      bash -lc "
        set -euo pipefail
        corepack enable
        pnpm install --filter @rs485-homenet/core... --no-frozen-lockfile
        pnpm --filter @rs485-homenet/core build
        node scripts/run-core.mjs
      "
    depends_on:
      simulator:
        condition: service_started
      mq:
        condition: service_started
    restart: unless-stopped

  ui:
    <<: *dev-base
    container_name: rs485-ui-dev
    environment:
      PORT: '3000'
      SERIAL_PORT: /simshare/rs485-sim-tty
      BAUD_RATE: '9600'
      MQTT_URL: mqtt://mq:1883
    ports:
      - '3000:3000'
    volumes:
      - ../../:/workspace
      - pnpm-store:/root/.local/share/pnpm
      - service_node_modules:/workspace/node_modules
      - simshare:/simshare
    command: >
      bash -lc "
        set -euo pipefail
        corepack enable
        pnpm install --filter @rs485-homenet/service... --filter @rs485-homenet/core... --filter @rs485-homenet/ui... --no-frozen-lockfile
        pnpm core:build
        pnpm service:build
        node packages/service/dist/server.js
      "
    depends_on:
      core:
        condition: service_started
      mq:
        condition: service_started
    restart: unless-stopped

volumes:
  mosquitto_data:
  mosquitto_log:
  homeassistant_config:
  simshare:
  pnpm-store:
  simulator_node_modules:
  core_node_modules:
  service_node_modules:
